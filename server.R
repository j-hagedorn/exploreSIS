## server.R ##

  shinyServer(
    function(input, output) { 
      
      ## REACTIVE SUBSETS #### 
      # Generated by reactive expressions to cache selected values 
      
      # Filtered scrub_sis data, all agencies
      sisInput <- reactive({  
        scrub_sis %<>% 
          filter(as.Date(sis_date) >= input$dateRange[1]
                 & as.Date(sis_date) <= input$dateRange[2])
      })
      
      # Filtered scrub_sis data, only selected agency
      sisByAgency <- reactive({  
        
        region_filt <- if (input$region == "All") {
          levels(sisInput()$PIHP)
        } else input$region
        
        agency_filt <- if (input$agency == "All") {
          levels(sisInput()$agency)
        } else input$agency
        
        sisInput() %>% 
          filter(PIHP %in% region_filt
                 & agency %in% agency_filt)
          
      })
      
      # Week-by-week trends
      per_wk <- reactive({
        
        per_wk <- 
          sisByAgency() %>%
          # Filter out expired assessments (> 3 yrs old)
          filter(due - as.Date(sis_date) <= (365 * 3)) %>%
          # Note we still use unfiltered dataset here to calc 
          # cumsum over wks without the date filter applied
          filter(as.POSIXct(sis_date) >= as.POSIXct("2011-12-12")
                 & as.Date(sis_date) <= Sys.Date()) %>%
          group_by(sis_yrwk) %>%
          summarize(n = n()) %>%
          rename(week = sis_yrwk) %>%
          mutate(
            week = as.Date(week),
            avg = NA
          ) %>%
          ungroup()
        
        if ((max(per_wk$week) + 7) > most_recent) {
          # If filtered dataset does contain most recent date, leave it be
          per_wk <- per_wk
        } else {
          # Create empty per week entries between last in seq and most recent in entire dataset
          new_wk <- seq.Date(from = max(per_wk$week) + 7, to = most_recent, by = "week") 
          new_wk <- as.data.frame(new_wk)
          new_wk %<>% rename(week = new_wk) %>% mutate(n = 0, avg = NA)
          per_wk %<>% rbind(new_wk)
        }
        
      })
      
      # List output of various completion metrics
      on_track_vars <- reactive({
        
        region_filt <- if (input$region == "All") {
          levels(sisInput()$PIHP)
        } else input$region
        
        agency_filt <- if (input$agency == "All") {
          levels(sisInput()$agency)
        } else input$agency
        
        # Generate list of reactive vars filtered based on inputs
        # to be used in calculations for 'on_track' and 'on_track_what_if' viz
        
        # Calculate average per week
        # Note that average per week is calculated for assessments completed within past 90 days
        # If a CMH has no assessments in the previous 90 days, an error is generated 
        avg_per_wk <- round(median(per_wk()$n[as.POSIXct(per_wk()$week) >= as.POSIXct(most_recent - 90)], 
                                 na.rm = T), digits = 0)
        
        recent_int <- length(unique(sisByAgency()$interviewer[as.POSIXct(sisByAgency()$sis_date) >= as.POSIXct(most_recent - 90)]))

        avg_person_wk <- ceiling( avg_per_wk / recent_int )
        
        completed <- 
          sisByAgency() %>%
          # Filter out expired assessments (> 3 yrs old)
          filter(as.Date(sis_date) >= most_recent - (365 * 3)) %>%
          # Filter out expired assessments as of due date (> 3 yrs old)
          filter(as.Date(due) - as.Date(sis_date) <= (365 * 3)) %>%
          droplevels()
        
        completed <- nlevels(as.factor(completed$fake_id))
        
        total_needed <- 
          totals %>% 
          filter(region %in% region_filt
                 & agency %in% agency_filt) %>%
          summarize(total = sum(total, na.rm = T))
        
        overdue <- sisByAgency() %>%
          group_by(fake_id) %>%
          summarize(max_sis_dt = max(sis_date)) %>%
          mutate(overdue = (max_sis_dt + (365*3)) < Sys.Date()) %>%
          ungroup() %>%
          summarize(overdue = sum(overdue, na.rm = T))
        
        # Output as named list
        list(
          avg_per_wk = avg_per_wk,
          recent_int = recent_int,
          avg_person_wk = avg_person_wk,
          completed = completed,
          overdue = overdue[1,1],
          total_needed = total_needed[1,1]
        )
        
      })
      
      # Long-format SIS data, with most recent assessment per person
      q1_3_person <- reactive({
        
        region_filt <- if (input$region == "All") {
          levels(scrub_sis$PIHP)
        } else input$region
        
        agency_filt <- if (input$agency == "All") {
          levels(scrub_sis$agency)
        } else input$agency
        
        # Section 2 and 3 input with one entry per person assessed
        q1_3 %>% 
          filter(
            PIHP %in% region_filt
            & agency %in% agency_filt
          ) %>% 
          filter(
            as.Date(sis_date) >= input$dateRange[1]
            & as.Date(sis_date) <= input$dateRange[2]
          ) %>%
          # Filter by person using most recent assessment outside of filter range
          group_by(fake_id) %>% 
          filter(as.Date(sis_date) == max(as.Date(sis_date))) %>% # Most recent per ID
          ungroup() %>% droplevels()
        
      })
      
      # Correlation matrix of selected items
      corr_df <- reactive({
        
        if (input$radio_relate_group == "Specific SIS items"  && input$filter_items == "All items") {
          cor_df <- q1_3_person() %>% rename(select_desc = item_desc)
        } else if(input$radio_relate_group == "Specific SIS items" && input$filter_items %in% unique(q1_3_person()$section_desc)){
          cor_df <- q1_3_person() %>% rename(select_desc = item_desc) %>% filter(section_desc == input$filter_items)
        } else if (input$radio_relate_group == "Grouped SIS subscales") {
          cor_df <- q1_3_person() %>% rename(select_desc = section_desc)
        } else if (input$radio_relate_group == "Predefined analyses" && input$filter_analyses == "Decision Making") {
          cor_df <- q1_3_person() %>% rename(select_desc = item_desc) %>% filter(dcsn_flg %in% c('p','s','t')) 
        }
       
        if(input$radio_relate_group == "Predefined analyses"){
          
          items <- cor_df %>%
            filter(is.na(score) == F) %>%
            group_by(fake_sis_id,select_desc) %>%
            summarize(score = sum(score))
          
          
          dcsn_total <- cor_df %>%
            filter(is.na(score) == F,
                   dcsn_flg == 'p') %>%
            mutate(select_desc = 'Primary Decision Making') %>%
            group_by(fake_sis_id,select_desc) %>%
            summarize(score = sum(score))
          
          all <- rbind(items,dcsn_total) %>%
            group_by(fake_sis_id) %>%
            spread(select_desc,score) %>%
            ungroup() %>%
            select(-fake_sis_id)
          
          all
          
        } else
          
        cor_df %>%
          filter(is.na(score) == F) %>%
          group_by(fake_sis_id,select_desc) %>%
          summarize(score = sum(score)) %>%
          group_by(fake_sis_id) %>%
          spread(select_desc,score) %>%
          ungroup() %>%
          select(-fake_sis_id)
        
      })
      
      output$filt_relate <- renderUI({
        
        if (input$radio_relate_group == "Grouped SIS subscales") {
          br()
        } else if (input$radio_relate_group == "Specific SIS items") {
          selectInput(
            "filter_items",
            label = "Filter the visualizations for items related to:",
            choices = c("All items",unique(q1_3_person()$section_desc)),
            selected = "All items"
          )
        } else if(input$radio_relate_group == "Predefined analyses") {
          selectInput(
            "filter_analyses",
            label = "Filter the visualizations for items related to:",
            choices = c("Decision Making"),
            selected = "Decision Making"
          )
        }
        
      })
      
      # Interviewer-related dataset
      interviewer <- reactive({
        
        # Percentage of assessments with no "Important to" fields completed
        imp_to <-
          sisByAgency() %>%
          filter(duration >= 0) %>% # removing assessment where duration is negative
          group_by(interviewer,fake_id) %>%
          select(interviewer,fake_id,ends_with("_ImportantTo")) %>%
          gather(field,n,ends_with("_ImportantTo")) %>%
          summarize(n_to = sum(n, na.rm = T)) %>%
          ungroup() %>%
          mutate(
            n_to_flg = ifelse(n_to == 0, 1, 0),
            n_to_five = ifelse(n_to > 5, 1, 0)
          ) %>%
          group_by(interviewer) %>%
          summarize(
            no_to = sum(n_to_flg),
            tot_five = sum(n_to_five),
            tot_assess = n()
          ) %>%
          mutate(
            pct_no_to = round((no_to/tot_assess), digits = 1),
            pct_to_five = round((tot_five/tot_assess), digits = 1)
          ) %>%
          select(interviewer,pct_no_to, pct_to_five)
        
        # Percentage of assessments with no "Important for" fields completed
        imp_for <-
          sisByAgency() %>%
          filter(duration >= 0) %>% # removing assessment where duration is negative
          group_by(interviewer,fake_id) %>%
          select(interviewer,fake_id,ends_with("_ImportantFor")) %>%
          gather(field,n,ends_with("_ImportantFor")) %>%
          summarize(n_for = sum(n, na.rm = T)) %>%
          ungroup() %>%
          mutate(
            n_for_flg = ifelse(n_for == 0, 1, 0),
            n_for_five = ifelse(n_for > 5, 1, 0)
          ) %>%
          group_by(interviewer) %>%
          summarize(
            no_for = sum(n_for_flg),
            tot_five = sum(n_for_five),
            tot_assess = n()
          ) %>%
          mutate(
            pct_no_for = round((no_for/tot_assess), digits = 1),
            pct_for_five = round((tot_five/tot_assess), digits = 1)
          ) %>%
          select(interviewer,pct_no_for, pct_for_five)
        
        # Correlation of related assessment items
        dq_cor <-
          q1_3 %>%
          # Filter to include items for correlation
          filter(
            item %in% c(
              "Q2A1_","Q2B1_","Q2B5_","Q2B8_",
              "Q2C3_","Q2C4_","Q2C9_",
              "Q2E6_","Q2E7_",
              "Q2F1_","Q2F3_","Q2F4_","Q2F5_","Q2F6_",
              "Q3A1_","Q3A8_"
            )
          ) %>%
          select(fake_sis_id,interviewer,item,score) %>%
          group_by(fake_sis_id,interviewer) %>%
          spread(item,score) %>%
          group_by(interviewer) %>%
          summarize(
            # Home appliances (Q2A1_) & Learning with tech (Q2C9_)
            cor_2a1_2c9 = round(cor(Q2A1_,Q2C9_, use = "complete.obs"), digits = 2),
            # Learning health skills (Q2C3_) & Nutrition/diet (Q2E6_)
            cor_2c3_2e6 = round(cor(Q2C3_,Q2E6_, use = "complete.obs"), digits = 2),
            # Learning health skills (Q2C3_) & Physical fitness (Q2E7_)
            cor_2c3_2e7 = round(cor(Q2C3_,Q2E7_, use = "complete.obs"), digits = 2),
            # Nutrition/diet (Q2E6_) & Physical fitness (Q2E7_)
            cor_2e6_2e7 = round(cor(Q2E6_,Q2E7_, use = "complete.obs"), digits = 2),
            # Transportation (Q2B1_) & Using public services (Q2B5_)
            cor_2b1_2b5 = round(cor(Q2B1_,Q2B5_, use = "complete.obs"), digits = 2),
            # Social skills (Q2F1_) & Socializing outside (Q2F3_)
            cor_2f1_2f3 = round(cor(Q2F1_,Q2F3_, use = "complete.obs"), digits = 2),
            # Socializing outside (Q2F3_) & Visit Friends/Family (Q2B8_)
            cor_2f3_2b8 = round(cor(Q2F3_,Q2B8_, use = "complete.obs"), digits = 2),
            # Socializing outside (Q2F3_) & Socializing at home (Q2F6_)
            cor_2f3_2f6 = round(cor(Q2F3_,Q2F6_, use = "complete.obs"), digits = 2),
            # Friendship (Q2F4_) & Intimate relationships (Q2F5_)
            cor_2f4_2f5 = round(cor(Q2F4_,Q2F5_, use = "complete.obs"), digits = 2),
            # Learning self-determination (Q2C4_) & Self-advocacy (Q3A1_)
            cor_2c4_3a1 = round(cor(Q2C4_,Q3A1_, use = "complete.obs"), digits = 2),
            # Self-advocacy (Q3A1_) & Advocating for others (Q3A8_)
            cor_3A1_3A8 = round(cor(Q3A1_,Q3A8_, use = "complete.obs"), digits = 2)
          )
        
        # Sum number of meeting attendees
        attend <-
          sisByAgency() %>%
          filter(duration >= 0) %>% # removing assessment where duration is negative
          select(interviewer,fake_id,sis_date,contains("reln")) %>%
          group_by(interviewer,fake_id,sis_date) %>%
          summarize(tot_attend = 
                      sum(sis_res1_reln == 0,sis_res2_reln == 0,sis_res3_reln == 0,
                          sis_res4_reln == 0,sis_res5_reln == 0,sis_res6_reln == 0,
                          sis_res7_reln == 0,sis_res8_reln == 0,sis_res9_reln == 0,
                          sis_res10_reln == 0)) %>%
          ungroup() %>%
          group_by(interviewer) %>%
          summarize(med_attend = median(tot_attend))
        
        
        mia <-
          sisByAgency() %>%
          filter(duration >= 0) %>% # removing assessment where duration is negative
          group_by(interviewer,current_int) %>%
          arrange(sis_date) %>%
          mutate(days_since = sis_date - lag(sis_date)) %>%
          summarize(miss_start = sum(as.numeric(hour(start) %in% c(0, NA))),
                    miss_end = sum(as.numeric(hour(end) %in% c(0, NA))),
                    miss_reason = sum(is.na(sis_why)),
                    not_mich = sum(as.numeric(sis_cl_st != "MI")),
                    # Attended all of or part of
                    cl_attend = sum(as.numeric(
                      sis_cl_attend == 1 | sis_cl_attend == 2), na.rm = T),
                    n = n(),
                    med_days_btwn = round(median(days_since, na.rm = T), digits = 1),
                    med_duration = round(median(duration, na.rm = T), digits = 1),
                    avg_dur = round(mean(duration, na.rm = T), digits = 0),
                    first = min(as.Date(sis_date)),
                    pct_attend = cl_attend / n
          ) %>%
          ungroup() %>%
          mutate(pct_total = n / sum(n),
                 med_days_btwn = as.numeric(med_days_btwn)) %>%
          left_join(imp_to, by = "interviewer") %>%
          left_join(imp_for, by = "interviewer") %>%
          left_join(attend, by = "interviewer") %>%
          left_join(dq_cor, by = "interviewer")
        
        mia
        
      })
      
      interviewer_wk <- reactive({
        
        sisByAgency() %>%
          filter(duration >= 0) %>%
          mutate(week = floor_date(sis_yrwk, unit = "week")) %>%
          group_by(interviewer,current_int,week) %>%
          summarize(
            duration_tot = sum(duration, na.rm = T), # total minutes
            n = n()
          ) %>%
          mutate(
            avg_dur = round((duration_tot/n), digits = 0)
          ) %>%
          group_by(week) %>%
          mutate(
            pct = round(n/sum(n)*100,digits = 2),
            running = order_by(interviewer, cumsum(pct))
          ) %>%
          ungroup()
        
      })
      
      boxInput <- reactive({
        
        sisByAgency() %>%
          filter(current_int == T) %>%
          droplevels() %>%
          select(interviewer,
                 fake_id,
                 medical = scr_1A_raw_total,
                 behavior = scr_1B_raw_total,
                 homeliving = scr_2A_std,
                 commliving = scr_2B_std,
                 hlthsafety = scr_2E_std,
                 lifelearng = scr_2C_std,
                 employment = scr_2D_std,
                 social = scr_2F_std,
                 SupportNeedsIndex = scr_support_needs_index) %>%
          mutate(ABE = homeliving + commliving + hlthsafety) %>%
          gather(subscale, score, medical:ABE, -interviewer) %>%
          mutate(subscale = car::recode(subscale, 
                                        "'medical' = 'Medical Supports';
                                        'behavior' = 'Behavioral Supports';
                                        'homeliving' = 'Home Living';
                                        'commliving' = 'Community Living';
                                        'hlthsafety' = 'Health and Safety';
                                        'lifelearng' = 'Lifelong Learning';
                                        'employment' = 'Employment';
                                        'social' = 'Social Activities';
                                        'ABE' = 'ABE Score';
                                        'SupportNeedsIndex' = 'Support Needs Index'"))
        
      })
      
      clusterInput <- reactive({
        
        #  Make dataframe for use in cluster analyses
        
        sisByAgency() %>%
          filter(is.na(fake_id) == FALSE) %>% # Remove empty randomized IDs
          # Include only most recent assessment data per ID
          group_by(fake_id) %>% 
          filter(as.Date(sis_date) == max(as.Date(sis_date))) %>% 
          ungroup() %>% droplevels() %>%
          select(contains("scr")) %>%
          rename(medical = scr_1A_raw_total,
                 behavior = scr_1B_raw_total,
                 home = scr_2A_std,
                 community = scr_2B_std,
                 safety = scr_2E_std,
                 learning = scr_2C_std,
                 employment = scr_2D_std,
                 social = scr_2F_std,
                 advocacy = scr_3_raw_total) %>%
          select(medical,behavior,home,community,safety,
                 learning,employment,social,advocacy)  %>%
          filter(is.na(medical) == F) %>%
          mutate_each(funs( as.numeric(scale(.) ))) %>% 
          filter(complete.cases(.))
        
      })
      
      cluster_km <- reactive({
        
        clusterInput() %>% 
          kmeans(centers = input$need_rows)
        
      })
      
      rand_id <- eventReactive(input$id_drop, {
        # Select a random ID when button is selected
        sample(q1_3_person()$fake_id, size = 1, replace = F)
      })
      
      ind_svs <- reactive({
        
        # Limit results to selected individual ID
        df <- 
          q1_3_person() %>% 
          mutate(
            type = ifelse(
              section %in% c("Q1A","Q1B"),
              yes = level, no = type
            )
          ) %>%
          select(-level) %>%
          filter(fake_id == rand_id())
        
        # Filter needs displayed based on user selection
        if ( input$filter_ipos == "Important to or for this person") {
          df %<>% filter(import_to == T | import_for == T) 
        } else if (input$filter_ipos == "Important to/for, or in a higher risk area") {
          df %<>% filter(import_to == T | import_for == T | need_svc == T)
        } else if (input$filter_ipos == "All needs") {
          df <- df
        } else print(paste0("Error.  Unrecognized input."))
        
        df %<>%
          # Identify areas with identified need (>0)
          filter(score > 0) %>%
          group_by(fake_id) %>%
          # Use only most recent SIS assessment scores
          filter(as.Date(sis_date) == max(as.Date(sis_date))) %>%
          ungroup() %>%
          select(
            section,section_desc,qol,item,item_desc,
            score,type,frequency,DST,importance
          ) %>%
          mutate(
            approx_min = dplyr::recode(
              DST,
              `None` = 0,
              `Under 30 min` = 15,
              `Under 2 hrs` = 75,
              `2-4 hrs` = 180,
              `Over 4 hrs` = 360
            ),
            x_per_month = dplyr::recode(
              frequency,
              `Minimal` = 0.5,
              # Monthly: at least once a month, but not once a week i.e. (1 + 4.34524) / 2
              `Monthly` = 2.67262,
              # Weekly: at least once a week, but not once a day i.e. (30 + 4.34524) / 2
              `Weekly` = 17.17262,
              `Daily` = 30,
              `Hourly` = 30 
            ),
            est_hrs_per_mo = round((approx_min / 60) * x_per_month, digits = 1)
          ) %>%
          left_join(need_to_hcpcs, by = "item") %>%
          select(-approx_min,-x_per_month) %>%
          group_by(item) %>%
          gather(
            HCPCS,need_mapped,everything(),
            # Don't gather grouping vars
            -section,-section_desc,-qol,-item,-item_desc,-score,
            -type,-frequency,-DST,-importance,-est_hrs_per_mo
          ) %>%
          filter(need_mapped == T) %>%
          ungroup() %>%
          left_join(codemap, by = "HCPCS") %>%
          # Calculate number of rows (i.e. needs) addressed by each service
          group_by(HCPCS) %>%
          mutate(
            deg_to = n(),
            cost_hr = med_unitcost / unit_hrs
          ) %>%
          ungroup()
        
        if ( input$filter_community_based == "An independent community-based setting") {
          df %<>% 
            filter(
              !HCPCS %in% c(
                # Residential settings
                "H2016","T1020",
                # Non-residential
                "H2014","T2015"
              )
            ) 
        } else if (input$filter_community_based == "A congregate facility-based setting is also acceptable") {
          df
        } else print(paste0("Error.  Unrecognized input."))
        
      })
      
      ind_svs_filt <- reactive({
        
        if (input$filter_ntwk_type == "The simplest set of services to address my needs") {
          ind_svs() %>%
            # For each need item, select only the HCPCS with greatest # of needs (deg_to)
            group_by(item) %>%
            filter(deg_to == max(deg_to)) %>%
            # When there are multiple services with equal related needs, pick lowest median unit cost
            filter(cost_hr == min(cost_hr))
        } else if (input$filter_ntwk_type == "All services which might be relevant") {
          ind_svs() %>%
            # Divide est hrs needed evenly across each potential service related to that need
            group_by(item) %>%
            mutate(est_hrs_per_mo = est_hrs_per_mo / n() ) %>%
            ungroup()
        } else print(paste0("Error.  Unrecognized input."))
        
      })
      
      ind_ntwk <- reactive({
        
        ind_svs_filt() %>%
          # Convert to network format
          select(
            from = item_desc,
            to = short_desc,
            score,
            est_hrs_per_mo
          ) %>%
          group_by(from,to) %>%
          summarize(
            score = max(score),
            est_hrs_per_mo = max(est_hrs_per_mo),
            n = n()
          ) %>%
          to_network()
        
      })
      
      ## REACTIVE UI ELEMENTS #### 
      
      output$valid_date <- renderText({
        
        validate(
          need(input$dateRange[2] >= input$dateRange[1],
               "End date is earlier than start date"
          )
        )
        
        # make sure greater than 2 week difference
        validate(
          need(difftime(input$dateRange[2], input$dateRange[1], 
                        "days") > 14, "Date range less the 14 days"
          )
        )
        
        # make sure last date is in dataset range
        validate(
          need(input$dateRange[2] <= max(as.Date(scrub_sis$sis_date)[as.Date(scrub_sis$sis_date) <= Sys.Date()]), 
               "End date beyond available data"
          )
        )
        
        # make sure start date is in dataset range
        validate(
          need(input$dateRange[1] >= min(as.Date(scrub_sis$sis_date)[as.Date(scrub_sis$sis_date) <= Sys.Date()]), 
               "Start date precedes available data"
          )
        )
        
        paste("Your date range is", 
              difftime(input$dateRange[2], input$dateRange[1], units = "days"),
              "days")
        
      })
      
      output$agency <- renderUI({
        
        filtre <- if (input$region == "All") {
          levels(scrub_sis$agency)
        } else 
          levels(droplevels(scrub_sis$agency[scrub_sis$PIHP == input$region]))
        
        selectInput(
          "agency",
          label = "Pick an agency:",
          choices = c("All", filtre), 
          selected = "All"
        )
        
      })
      
      output$what_staff <- renderUI({
        
        sliderInput(
          inputId = "what_staff", 
          "...we changed the number of SIS interviewers?",
          min = on_track_vars()$recent_int * -1,
          max = on_track_vars()$recent_int,
          value = 0,
          step = 1,
          round = T
        )
        
      })
      
      output$what_prod <- renderUI({

        min_avg_wk <- round(on_track_vars()$avg_person_wk * 0.5, digits = 0)
        max_avg_wk <- round(on_track_vars()$avg_person_wk * 3, digits = 0)
        
        sliderInput(
          inputId = "what_prod",
          "...each interviewer completed fewer/more assessments per week?",
          min = 0,
          max = ifelse(max_avg_wk < 3, yes = 3, no = max_avg_wk),
          value = on_track_vars()$avg_person_wk,
          step = 0.5,
          round = T
        )

      })
      
      output$q2_3domain <- renderUI({
        
        filtre <- if (input$select_area_q2_3 == "All") {
          q1_3_person() %>%
            filter(!section %in% c("Q1A","Q1B")) %>%
            select(item_desc) %>% unique() %>% 
            as.list() %>% .$item_desc
        } else 
          q1_3_person() %>%
            filter(!section %in% c("Q1A","Q1B")) %>%
            filter(section_desc == input$select_area_q2_3) %>%
            select(item_desc) %>% unique() %>% 
            as.list() %>% .$item_desc

        selectInput(
          "q2_3domain",
          label = "Select a specific need:",
          choices = filtre, 
          selected = ""
        )
        
      })
      
      output$par_coords_ui <- renderUI({
        
        box(
          title = "What are parallel coordinates?",
          collapsible = T, 
          collapsed = T,
          width = NULL,
          p(
            "In a parallel coordinates plot, each variable is given a vertical axis and 
            all the axes are placed in a row, parallel to each other. Each axis can 
            have a different scale, since they are different measures. The 
            responses from each assessment are plotted as a line that connects 
            across all the axes."
          ),
          p(
            "The order in which the axes are arranged can impact the way you 
            understand the data, since the relationships between adjacent 
            variables are easier to perceive. Moving an item left or right to
            reorder the axes can help in discovering patterns or correlations 
            across variables. You can also select which variable to color the 
            lines by in order to see the different relationships."
          ),
          p(
            "The parallel coordinates plot can also be filtered for a subset of
            scores within one or more of the selected variables. Move your cursor 
            across the vertical axis of a particular item to highlight the desired 
            range of scores."
          ),
          inputPanel(
            selectInput(
              "color_parcoord",
              label = "Color lines by:",
              choices = colnames(corr_df())
            )  
          )
        )
        
      })
      
      output$scatter_vars_x <- renderUI({
        
        selectInput(
          "scatter_vars_x",
          label = "Select x axis:",
          choices = names(corr_df())
        )
        
      })
      
      output$scatter_vars_y <- renderUI({
        
        selectInput(
          "scatter_vars_y",
          label = "Select y axis:",
          choices = names(corr_df()[,!(names(corr_df()) %in% (input$scatter_vars_x))])
        )
        
      })
      
      output$box_opts <- renderUI({
        
        if (input$region == "All" && input$agency == "All") {
          
          br()
        
          } else
        
        # Make subset for subscale selection
        box_sis <- boxInput()
        selectInput(
          "box",
          label = "Select a subscale/area:",
          choices = levels(as.factor(box_sis$subscale)), 
          selected = "Support Needs Index")
        
      })
      
      output$import <- renderUI({
        
        selectInput(
          "import",
          label = "Show life domains important to/for the person:",
          choices = c("All", unique(q1_3_person()$importance)), 
          selected = "All"
        )
        
      })
      
      output$id_drop <- renderUI({
        
        actionButton("id_drop", "Select new")
        
       })
      
      output$k_vars <- renderUI({
        
        # Create multiple dropdowns, each displaying a different colname
        
        tagList(
          selectInput("kmPlot_x", "X-axis: ",
                      choices = names(clusterInput()),
                      selected = names(clusterInput())[1]),
          selectInput("kmPlot_y", "Y-axis: ",
                      choices = names(clusterInput()),
                      selected = names(clusterInput())[2]),
          selectInput("kmPlot_z", "Z-axis: ",
                      choices = names(clusterInput()),
                      selected = names(clusterInput())[3]),
          selectInput("kmPlot_size", "Size: ",
                      choices = names(clusterInput()),
                      selected = names(clusterInput())[4])
        )
        
      })
      
      ## VISUALIZATIONS ####
  
      output$all_complete <- renderValueBox({
        
        valueBox(
          prettyNum(on_track_vars()$completed,big.mark = ","), 
          "Assessments Completed", 
          icon = icon("file"),
          color = "teal")
        
      })
      
      output$not_complete <- renderValueBox({
        
        incomplete_init <- on_track_vars()$total_needed - on_track_vars()$completed
        not_complete <- incomplete_init + on_track_vars()$overdue
        
        valueBox(
          prettyNum(not_complete, big.mark = ","), 
          "Assessments Due", 
          icon = icon("hourglass-end"),
          color = ifelse(not_complete >= 1, no = "green", yes = "red")
        )
        
      })
      
      output$per_mo_line <- renderPlotly({
        
        done_per_mo <- 
          sisByAgency() %>%
          filter(
            as.POSIXct(sis_date) >= as.POSIXct("2011-12-12")
            & as.Date(sis_date) <= Sys.Date()
            # Remove current month
            & as.Date(sis_date) < floor_date(most_recent, unit = "month")
          ) %>%
          mutate(
            sis_month = floor_date(sis_date, unit = "month")
          ) %>%
          group_by(sis_month) %>%
          summarize(n = n()) %>%
          rename(month = sis_month) %>%
          mutate(
            month = as.Date(month)
          ) %>%
          ungroup()
        
        due_per_mo <-
          sisByAgency() %>%
          filter(
            as.POSIXct(sis_date) >= as.POSIXct("2011-12-12")
            & as.Date(sis_date) <= Sys.Date()
            # Remove current month
            & as.Date(sis_date) < floor_date(most_recent, unit = "month")
          ) %>%
          mutate(
            due_date = sis_date + (365 * 3),
            due_month = floor_date(due_date, unit = "month")
          ) %>%
          group_by(due_month) %>%
          summarize(n_due = n()) %>%
          rename(month = due_month) %>%
          mutate(
            month = as.Date(month)
          ) %>%
          ungroup()
        
        incomplete_init <- on_track_vars()$total_needed - on_track_vars()$completed
        
        need_per_mo <- 
          seq.Date(
            from = floor_date(most_recent, unit = "month"), 
            to = max(due_per_mo$month), 
            by = "month"
          ) 
        
        need_per_mo <- 
          as.data.frame(need_per_mo) %>%
          slice(1:input$spread_init) %>%
          rename(month = need_per_mo) %>%
          mutate(n_need = round(incomplete_init/input$spread_init)) 
        
        per_mo <-
          done_per_mo %>%
          full_join(due_per_mo, by = "month") %>%
          full_join(need_per_mo, by = "month")
        
        per_mo %>%
          plot_ly(
            x = ~month
          ) %>%
          add_lines(
            y = ~n,
            name = "Assessments Complete",
            hoverinfo = 'text',
            text = ~paste(
              n," assessments were completed",
              "<br>during ",month(month,T,F)," of ",year(month)
            )
          ) %>%
          add_bars(
            y = ~n_due,
            color = I("#c6dbef"),
            name = "Reassessments Due",
            hoverinfo = 'text',
            text = ~paste(
              n_due," people have repeat assessments ",
              "<br>due in ",month(month,T,F)," of ",year(month)
            )
          ) %>%
          add_bars(
            y = ~n_need,
            color = I("#deebf7"),
            name = "Initial Remaining",
            hoverinfo = 'text',
            text = ~paste(
              n_need," initial assessments would need to be completed",
              "<br>in ",month(month,T,F)," of ",year(month)," in order to",
              "<br>complete all remaining initial assessments within ",
              input$spread_init," months."
            )
          ) %>%
          layout(
            title = "Monthly Trend",
            xaxis = list(title = 'Month'),
            yaxis = list(title = 'Assessments'),
            barmode = 'stack'
          )
        
      })
      
      output$overdue <- renderValueBox({
        
        valueBox(
          prettyNum(on_track_vars()$overdue, big.mark = ","), 
          "Overdue Re-Assessments", 
          icon = icon(ifelse(on_track_vars()$overdue >= 1,
                             no = "thumbs-up",
                             yes = "thumbs-down")),
          color = ifelse(on_track_vars()$overdue >= 1,
                         no = "green",
                         yes = "red")
        )
        
      })
      
      output$due30 <- renderValueBox({
        
        due30 <- sisByAgency() %>%
          group_by(fake_id) %>%
          summarize(max_sis_dt = max(sis_date)) %>%
          mutate(due30 = max_sis_dt + (365*3) >= Sys.Date() & max_sis_dt + (365*3) <= Sys.Date() + 30) %>%
          ungroup() %>%
          summarize(due30T = sum(due30, na.rm = T))
        
        
        valueBox(
          paste0(due30$due30T), "Re-Assessments Due in Next 30 Days", 
          icon = icon("calendar"),
          color = "yellow"
        )
      })
      
      output$tocomplete <- renderValueBox({
        
        tocomplete <- 
          sisByAgency() %>%
          group_by(fake_id) %>%
          summarize(max_sis_dt = max(sis_date)) %>%
          mutate(
            overdue = (max_sis_dt + (365*3)) < Sys.Date(),
            due12m = max_sis_dt + (365*3) >= Sys.Date() & max_sis_dt + (365*3) <= Sys.Date() + 365
          ) %>%
          ungroup %>%
          summarize(
            to_complete = round(sum(overdue,due12m, na.rm = T)/12, digits = 0)
          )
        
        initial_per_mo <- (on_track_vars()$total_needed - on_track_vars()$completed) / 12
        total_per_mo <- ceiling(tocomplete[1,1] + initial_per_mo)
        
        valueBox(
          paste0("Complete ",prettyNum(total_per_mo, big.mark = ","), " per month"),
          "To Stay on Track (Includes Overdue Assessments)",
          icon = icon("check"),
          color = "teal"
        )
        
      })
      
      output$bymonth <- renderPlotly({

        sisByAgency() %>%
          group_by(fake_id) %>%
          summarize(
            max_sis_dt = max(sis_date)
          ) %>%
          mutate(
            due_dt = max_sis_dt + (365*3),
            due_yrwk = as.Date(paste(month(due_dt),"1",year(due_dt), sep = "-"), format = "%m-%d-%Y"),
            due = as.yearmon(due_yrwk),
            days_due = (due_dt - Sys.Date())
          ) %>%
          ungroup() %>%
          group_by(due,due_yrwk) %>%
          summarize(n = n()) %>%
          # filter to include current month and next 11 months
          filter(
            due >= as.yearmon(Sys.Date()) 
            & due_yrwk <= max(Sys.Date() %m+% months(c(0:11)))
          ) %>%
          plot_ly(
            x = ~due_yrwk,
            y = ~n,
            type = 'bar',
            hoverinfo = 'text',
            text = ~paste(n," people have repeat assessments ",
                          "<br>due in ",month(due_yrwk,T,F)," of ",year(due_yrwk))
          ) %>%
          layout(
            title = "Updated Assessments Due by Month",
            xaxis = list(title = "Month/Year"),
            yaxis = list(title = "# Assessments due during month")
          )
        
      })
      
      output$bydayct <- renderPlotly({

        sisByAgency() %>%
          group_by(fake_id) %>%
          summarize(
            max_sis_dt = max(sis_date)
          ) %>%
          mutate(
            due_dt = as.Date(max_sis_dt) + (365*3),
            days_due = (due_dt - Sys.Date()),
            days_due_ct = case_when(
              days_due < 0 ~ "Overdue",
              days_due %in% c(0:30) ~ "0-30 days",
              days_due %in% c(31:60) ~ "31-60 days",
              days_due %in% c(61:90) ~ "61-90 days",
              days_due %in% c(91:120) ~ "91-120 days",
              days_due %in% c(121:150) ~ "121-150 days",
              days_due %in% c(151:365) ~ "6-12 months",
              days_due %in% c(366:730) ~ "1-2 years",
              days_due > 730 ~ "2+ years"
            ),
            days_due_ct = factor(
              days_due_ct,
              levels = c(
                "Overdue","0-30 days","31-60 days","61-90 days","91-120 days",
                "121-150 days","6-12 months","1-2 years","2+ years"
              )
            )
          ) %>%
          ungroup() %>%
          group_by(days_due_ct) %>%
          summarize(n = n()) %>%
          plot_ly(
            x = ~days_due_ct,
            y = ~n,
            type = 'bar',
            hoverinfo = 'text',
            text = ~paste("Assessments due: ",n,
                          "<br>Due in: ",days_due_ct)
          ) %>%
          layout(
            title = "Assessments Due by Day",
            xaxis = list(title = "Timeframe", tickangle = 90),
            yaxis = list(title = "# Assessments"),
            margin = list(b = 200)
          )

      })

      output$rate <- renderValueBox({
        
        # Proportion of days in selected timeframe 
        # to days between initial date selected & due date
        elapse <- 
          as.numeric(as.POSIXct(input$dateRange[2]) - as.POSIXct(input$dateRange[1])) / 
          as.numeric(as.POSIXct(due) - as.POSIXct(input$dateRange[1])) * 100
        
        # Proportion of clients interviewed in selected time period 
        # to total current clients meeting criteria
        
        pct <- 
          sum(on_track_vars()$completed) /
          sum(on_track_vars()$total_needed) * 100
          
        rate <- pct / elapse * 100
        
        valueBox(
          paste0(round(rate, digits = 1), "%"), "Completion Rate for Initial Assessments", 
          icon = icon(ifelse(rate >= 100,
                             yes = "thumbs-up",
                             no = "thumbs-down")),
          color = ifelse(rate >= 100,
                         yes = "green",
                         no = "red")
        )
        
      })
      
      output$complete <- renderValueBox({
        
        pct <- 
          sum(on_track_vars()$completed) /
          sum(on_track_vars()$total_needed) * 100
        
        valueBox(
          paste0(round(pct, digits = 1), "%"), 
          paste0(
            "of Initial Assessments Complete (n = ",
            prettyNum(on_track_vars()$completed,big.mark = ",")," / ",
            prettyNum(on_track_vars()$total_needed,big.mark = ","),")"
          ), 
          icon = icon("pie-chart"),
          color = "teal")
        
      })
      
      output$needperwk <- renderValueBox({
        
        week <- seq(from = max(as.Date(per_wk()$week)), to = due, by = "week")
        
        needed <- 
          ceiling((on_track_vars()$total_needed - on_track_vars()$completed)
                  / length(week))
        
        valueBox(
          paste0("Complete ",
                 round(needed, digits = 1), " per week"), 
          "From now on to meet the goal", 
          icon = icon("hourglass-half"),
          color = "teal")
        
      })
      
      overview <- reactive({
        
        is_current <- if (input$current == "Current assessors") {
          c(TRUE)
        } else if (input$current == "All Assessors") {
          c(TRUE, FALSE)
        } else print(paste0("Error.  Unrecognized input."))
        
        # Percentage of assessments with no "Important to" fields completed
        imp_to <-
          sisByAgency() %>%
          filter(current_int %in% is_current) %>%
          filter(duration >= 0) %>% # removing assessment where duration is negative
          group_by(fake_id) %>%
          select(fake_id,ends_with("_ImportantTo")) %>%
          gather(field,n,ends_with("_ImportantTo")) %>%
          summarize(n_to = sum(n, na.rm = T)) %>%
          ungroup() %>%
          mutate(n_to_flg = ifelse(n_to == 0, 1, 0)) %>%
          summarize(n_to = sum(n_to_flg),
                    n = n()
          ) %>%
          mutate(pct_no_to = n_to/n) %>%
          select(pct_no_to)
        
        # Percentage of assessments with no "Important for" fields completed
        imp_for <-
          sisByAgency() %>%
          filter(current_int %in% is_current) %>%
          filter(duration >= 0) %>% # removing assessment where duration is negative
          group_by(fake_id) %>%
          select(fake_id,ends_with("_ImportantFor")) %>%
          gather(field,n,ends_with("_ImportantFor")) %>%
          summarize(n_for = sum(n, na.rm = T)) %>%
          ungroup() %>%
          mutate(n_for_flg = ifelse(n_for == 0, 1, 0)) %>%
          summarize(n_for = sum(n_for_flg),
                    n = n()
          ) %>%
          mutate(pct_no_for = n_for/n) %>%
          select(pct_no_for)
        
        # Correlation of related assessment items
        dq_cor <-
          q1_3 %>%
          # Filter to include items for correlation
          filter(
            item %in% c(
              "Q2A1_","Q2B1_","Q2B5_","Q2B8_",
              "Q2C3_","Q2C4_","Q2C9_",
              "Q2E6_","Q2E7_",
              "Q2F1_","Q2F3_","Q2F4_","Q2F5_","Q2F6_",
              "Q3A1_","Q3A8_"
            )
          ) %>%
          select(fake_sis_id,item,score) %>%
          group_by(fake_sis_id) %>%
          spread(item,score)
        
        cor <- cbind(
          # Home appliances (Q2A1_) & Learning with tech (Q2C9_)
          cor_2a1_2c9 = round(cor(dq_cor$Q2A1_,dq_cor$Q2C9_, use = "complete.obs"), digits = 2),
          # Learning health skills (Q2C3_) & Nutrition/diet (Q2E6_)
          cor_2c3_2e6 = round(cor(dq_cor$Q2C3_,dq_cor$Q2E6_, use = "complete.obs"), digits = 2),
          # Learning health skills (Q2C3_) & Physical fitness (Q2E7_)
          cor_2c3_2e7 = round(cor(dq_cor$Q2C3_,dq_cor$Q2E7_, use = "complete.obs"), digits = 2),
          # Nutrition/diet (Q2E6_) & Physical fitness (Q2E7_)
          cor_2e6_2e7 = round(cor(dq_cor$Q2E6_,dq_cor$Q2E7_, use = "complete.obs"), digits = 2),
          # Transportation (Q2B1_) & Using public services (Q2B5_)
          cor_2b1_2b5 = round(cor(dq_cor$Q2B1_,dq_cor$Q2B5_, use = "complete.obs"), digits = 2),
          # Social skills (Q2F1_) & Socializing outside (Q2F3_)
          cor_2f1_2f3 = round(cor(dq_cor$Q2F1_,dq_cor$Q2F3_, use = "complete.obs"), digits = 2),
          # Socializing outside (Q2F3_) & Visit Friends/Family (Q2B8_)
          cor_2f3_2b8 = round(cor(dq_cor$Q2F3_,dq_cor$Q2B8_, use = "complete.obs"), digits = 2),
          # Socializing outside (Q2F3_) & Socializing at home (Q2F6_)
          cor_2f3_2f6 = round(cor(dq_cor$Q2F3_,dq_cor$Q2F6_, use = "complete.obs"), digits = 2),
          # Friendship (Q2F4_) & Intimate relationships (Q2F5_)
          cor_2f4_2f5 = round(cor(dq_cor$Q2F4_,dq_cor$Q2F5_, use = "complete.obs"), digits = 2),
          # Learning self-determination (Q2C4_) & Self-advocacy (Q3A1_)
          cor_2c4_3a1 = round(cor(dq_cor$Q2C4_,dq_cor$Q3A1_, use = "complete.obs"), digits = 2),
          # Self-advocacy (Q3A1_) & Advocating for others (Q3A8_)
          cor_3A1_3A8 = round(cor(dq_cor$Q3A1_,dq_cor$Q3A8_, use = "complete.obs"), digits = 2)
        )
        
        # Sum number of meeting attendees
        attend <-
          sisByAgency() %>%
          filter(current_int %in% is_current) %>%
          filter(duration >= 0) %>% # removing assessment where duration is negative
          select(fake_id,sis_date,contains("reln")) %>%
          group_by(fake_id,sis_date) %>%
          summarize(tot_attend = 
                      sum(sis_res1_reln == 0,sis_res2_reln == 0,sis_res3_reln == 0,
                          sis_res4_reln == 0,sis_res5_reln == 0,sis_res6_reln == 0,
                          sis_res7_reln == 0,sis_res8_reln == 0,sis_res9_reln == 0,
                          sis_res10_reln == 0)) %>%
          ungroup() %>%
          summarize(med_attend = median(tot_attend))
        
        
        mia <-
          sisByAgency() %>%
          filter(current_int %in% is_current) %>%
          filter(duration >= 0) %>% # removing assessment where duration is negative
          arrange(sis_date) %>%
          summarize(miss_start = sum(as.numeric(hour(start) %in% c(0, NA))),
                    miss_end = sum(as.numeric(hour(end) %in% c(0, NA))),
                    miss_reason = sum(is.na(sis_why)),
                    not_mich = sum(as.numeric(sis_cl_st != "MI"), na.rm = T),
                    # Attended all of or part of
                    cl_attend = sum(as.numeric(
                      sis_cl_attend == 1 | sis_cl_attend == 2), na.rm = T),
                    n = n(),
                    med_duration = round(median(duration, na.rm = T), digits = 1),
                    avg_dur = round(mean(duration, na.rm = T), digits = 0),
                    pct_attend = (cl_attend / n)
          ) %>%
          ungroup() %>%
          cbind(imp_to) %>%
          cbind(imp_for) %>%
          cbind(attend) %>%
          cbind(cor)
        
        mia
        
      })
      
      
      interviewer <- reactive({
        
        # Percentage of assessments with no "Important to" fields completed
        imp_to <-
          sisByAgency() %>%
          filter(duration >= 0) %>% # removing assessment where duration is negative
          group_by(interviewer,fake_id) %>%
          select(interviewer,fake_id,ends_with("_ImportantTo")) %>%
          gather(field,n,ends_with("_ImportantTo")) %>%
          summarize(n_to = sum(n, na.rm = T)) %>%
          ungroup() %>%
          mutate(
            n_to_flg = ifelse(n_to == 0, 1, 0),
            n_to_five = ifelse(n_to > 5, 1, 0)
          ) %>%
          group_by(interviewer) %>%
          summarize(
            no_to = sum(n_to_flg),
            tot_five = sum(n_to_five),
            tot_assess = n()
          ) %>%
          mutate(
            pct_no_to = round((no_to/tot_assess), digits = 1),
            pct_to_five = round((tot_five/tot_assess), digits = 1)
          ) %>%
          select(interviewer,pct_no_to, pct_to_five)
        
        # Percentage of assessments with no "Important for" fields completed
        imp_for <-
          sisByAgency() %>%
          filter(duration >= 0) %>% # removing assessment where duration is negative
          group_by(interviewer,fake_id) %>%
          select(interviewer,fake_id,ends_with("_ImportantFor")) %>%
          gather(field,n,ends_with("_ImportantFor")) %>%
          summarize(n_for = sum(n, na.rm = T)) %>%
          ungroup() %>%
          mutate(
            n_for_flg = ifelse(n_for == 0, 1, 0),
            n_for_five = ifelse(n_for > 5, 1, 0)
          ) %>%
          group_by(interviewer) %>%
          summarize(
            no_for = sum(n_for_flg),
            tot_five = sum(n_for_five),
            tot_assess = n()
          ) %>%
          mutate(
            pct_no_for = round((no_for/tot_assess), digits = 1),
            pct_for_five = round((tot_five/tot_assess), digits = 1)
          ) %>%
          select(interviewer,pct_no_for, pct_for_five)
        
        # Correlation of related assessment items
        dq_cor <-
          q1_3 %>%
          # Filter to include items for correlation
          filter(
            item %in% c(
              "Q2A1_","Q2B1_","Q2B5_","Q2B8_",
              "Q2C3_","Q2C4_","Q2C9_",
              "Q2E6_","Q2E7_",
              "Q2F1_","Q2F3_","Q2F4_","Q2F5_","Q2F6_",
              "Q3A1_","Q3A8_"
            )
          ) %>%
          select(fake_sis_id,interviewer,item,score) %>%
          group_by(fake_sis_id,interviewer) %>%
          spread(item,score) %>%
          group_by(interviewer) %>%
          summarize(
            # Home appliances (Q2A1_) & Learning with tech (Q2C9_)
            cor_2a1_2c9 = round(cor(Q2A1_,Q2C9_, use = "complete.obs"), digits = 2),
            # Learning health skills (Q2C3_) & Nutrition/diet (Q2E6_)
            cor_2c3_2e6 = round(cor(Q2C3_,Q2E6_, use = "complete.obs"), digits = 2),
            # Learning health skills (Q2C3_) & Physical fitness (Q2E7_)
            cor_2c3_2e7 = round(cor(Q2C3_,Q2E7_, use = "complete.obs"), digits = 2),
            # Nutrition/diet (Q2E6_) & Physical fitness (Q2E7_)
            cor_2e6_2e7 = round(cor(Q2E6_,Q2E7_, use = "complete.obs"), digits = 2),
            # Transportation (Q2B1_) & Using public services (Q2B5_)
            cor_2b1_2b5 = round(cor(Q2B1_,Q2B5_, use = "complete.obs"), digits = 2),
            # Social skills (Q2F1_) & Socializing outside (Q2F3_)
            cor_2f1_2f3 = round(cor(Q2F1_,Q2F3_, use = "complete.obs"), digits = 2),
            # Socializing outside (Q2F3_) & Visit Friends/Family (Q2B8_)
            cor_2f3_2b8 = round(cor(Q2F3_,Q2B8_, use = "complete.obs"), digits = 2),
            # Socializing outside (Q2F3_) & Socializing at home (Q2F6_)
            cor_2f3_2f6 = round(cor(Q2F3_,Q2F6_, use = "complete.obs"), digits = 2),
            # Friendship (Q2F4_) & Intimate relationships (Q2F5_)
            cor_2f4_2f5 = round(cor(Q2F4_,Q2F5_, use = "complete.obs"), digits = 2),
            # Learning self-determination (Q2C4_) & Self-advocacy (Q3A1_)
            cor_2c4_3a1 = round(cor(Q2C4_,Q3A1_, use = "complete.obs"), digits = 2),
            # Self-advocacy (Q3A1_) & Advocating for others (Q3A8_)
            cor_3A1_3A8 = round(cor(Q3A1_,Q3A8_, use = "complete.obs"), digits = 2)
          )
        
        # Sum number of meeting attendees
        attend <-
          sisByAgency() %>%
          filter(duration >= 0) %>% # removing assessment where duration is negative
          select(interviewer,fake_id,sis_date,contains("reln")) %>%
          group_by(interviewer,fake_id,sis_date) %>%
          summarize(tot_attend = 
                      sum(sis_res1_reln == 0,sis_res2_reln == 0,sis_res3_reln == 0,
                          sis_res4_reln == 0,sis_res5_reln == 0,sis_res6_reln == 0,
                          sis_res7_reln == 0,sis_res8_reln == 0,sis_res9_reln == 0,
                          sis_res10_reln == 0)) %>%
          ungroup() %>%
          group_by(interviewer) %>%
          summarize(med_attend = median(tot_attend))
        
        
        mia <-
          sisByAgency() %>%
          filter(duration >= 0) %>% # removing assessment where duration is negative
          group_by(interviewer,current_int) %>%
          arrange(sis_date) %>%
          mutate(days_since = sis_date - lag(sis_date)) %>%
          summarize(miss_start = sum(as.numeric(hour(start) %in% c(0, NA))),
                    miss_end = sum(as.numeric(hour(end) %in% c(0, NA))),
                    miss_reason = sum(is.na(sis_why)),
                    not_mich = sum(as.numeric(sis_cl_st != "MI"), na.rm = T),
                    # Attended all of or part of
                    cl_attend = sum(as.numeric(
                      sis_cl_attend == 1 | sis_cl_attend == 2), na.rm = T),
                    n = n(),
                    med_days_btwn = round(median(days_since, na.rm = T), digits = 1),
                    med_duration = round(median(duration, na.rm = T), digits = 1),
                    avg_dur = round(mean(duration, na.rm = T), digits = 0),
                    first = min(as.Date(sis_date)),
                    pct_attend = cl_attend / n
          ) %>%
          ungroup() %>%
          mutate(pct_total = n / sum(n),
                 med_days_btwn = as.numeric(med_days_btwn)) %>%
          left_join(imp_to, by = "interviewer") %>%
          left_join(imp_for, by = "interviewer") %>%
          left_join(attend, by = "interviewer") %>%
          left_join(dq_cor, by = "interviewer")
        
        mia
        
      })
      
      interviewer_wk <- reactive({

        sisByAgency() %>%
          filter(duration >= 0) %>%
          mutate(week = floor_date(sis_yrwk, unit = "week")) %>%
          group_by(interviewer,current_int,week) %>%
          summarize(
            duration_tot = sum(duration, na.rm = T), # total minutes
            n = n()
          ) %>%
          mutate(
            avg_dur = round((duration_tot/n), digits = 0)
          ) %>%
          group_by(week) %>%
          mutate(
            pct = round(n/sum(n)*100,digits = 2),
            running = order_by(interviewer, cumsum(pct))
          ) %>%
          ungroup()

      })
      
      output$num_dt <- renderDataTable({
        
        is_current <- if (input$is_current == "Current assessors") {
          c(TRUE)
        } else if (input$is_current == "All Assessors") {
          c(TRUE, FALSE)
        } else print(paste0("Error.  Unrecognized input."))
        
        interviewer() %>%
          filter(current_int %in% is_current) %>%
          select(interviewer,n,avg_dur,first) %>%
          datatable(caption = 'SIS assessment summary by Interviewer.',
                    rownames = FALSE,
                    colnames = c('Interviewer',
                                 '# Assessments','Avg minutes',
                                 'Interviewing since'),
                    extensions = c('Responsive','Buttons'),
                    options = list(pageLength = 5, lengthMenu = c(5, 15),
                                   dom = 'C<"clear">lfrtip',
                                   buttons = c('colvis'))) %>%
          formatDate(4)
      })

      output$on_track <- renderDygraph({
        
        per_wk <- per_wk()
        
        avg <-
          seq(from = sum(per_wk$n, na.rm = T) + on_track_vars()$avg_per_wk,
              to = on_track_vars()$total_needed,
              by = on_track_vars()$avg_per_wk
          )
        
        tst <- 
          as.data.frame(avg) %>%
          mutate(
            n = NA,
            week = seq(from = max(as.Date(per_wk$week)), by = "week", length.out = length(avg))
          ) %>%
          select(week,n,avg)
        
        per_wk$week <- as.Date(per_wk$week) # Make date types the same
        
        per_wk <- rbind(per_wk,tst)
        
        per_wk <-
          per_wk %>%
          ungroup() %>%
          mutate(running = order_by(week, cumsum(n))) 
        
        per_wk$week <- as.POSIXct(per_wk$week)
        
        per_wk_srs <- as.xts(per_wk$running, order.by = per_wk$week)
        
        names(per_wk_srs)[1] <- "running"
        
        per_wk_srs$avg <- per_wk$avg

        dygraph(per_wk_srs, main = "Cumulative SIS assessments") %>%
          dyAxis("x", label = "Week of Assessments") %>%
          dyAxis("y", label = "# SIS assessments (cumulative)",
                 valueRange = c(0, max(per_wk$need))) %>%
          dySeries("running", label = "Actual", 
                   strokeWidth = 2, fillGraph = TRUE) %>%
          dySeries("avg", label = "If trend continues",
                   strokeWidth = 2, strokePattern = "dashed") %>%
          dyLegend(width = 400) %>%
          dyEvent(x = "2012-01-22", "Ottawa Starts", labelLoc = "bottom") %>%
          dyEvent(x = "2014-07-01", "Region Starts", labelLoc = "bottom") %>%
          dyEvent(x = "2017-09-20", "Deadline", labelLoc = "bottom") %>%
          dyAnnotation(
            max(per_wk$week), text = "Projected completion",
            tooltip = "Date by which initial assessments will be completed if average completion rate continues.",
            width = 80, height = 35
          ) %>%
          dyRangeSelector(dateWindow = c(as.Date(input$dateRange[1]), as.Date(max(per_wk$week))))
        
      })

      output$on_track_what_if <- renderDygraph({
        
        per_wk <- per_wk()
        
        proj_per_wk <- input$what_prod * (on_track_vars()$recent_int + input$what_staff)
        
        avg <-
          seq(
            from = sum(per_wk$n, na.rm = T) + proj_per_wk,
            to = on_track_vars()$total_needed,
            by = proj_per_wk
          )
        
        projected <- 
          as.data.frame(avg) %>%
          mutate(
            n = NA,
            week = seq(
              from = max(as.Date(per_wk$week)), 
              by = "week", 
              length.out = length(avg)
            )
          ) %>%
          select(week,n,avg)
        
        per_wk$week <- as.Date(per_wk$week) # Make date types the same
        
        per_wk <- rbind(per_wk,projected)
        
        per_wk <-
          per_wk %>%
          ungroup() %>%
          mutate(running = order_by(week, cumsum(n))) 
        
        per_wk$week <- as.POSIXct(per_wk$week)
        
        per_wk_srs <- as.xts(per_wk$running, order.by = per_wk$week)
        
        names(per_wk_srs)[1] <- "running"
        
        per_wk_srs$avg <- per_wk$avg
        
        dygraph(per_wk_srs, main = "What if...? Projections") %>%
          dyAxis("x", label = "Week of Assessments") %>%
          dyAxis("y", label = "# SIS assessments (cumulative)",
                 valueRange = c(0, max(per_wk$need))) %>%
          dySeries("running", label = "Actual", 
                   strokeWidth = 2, fillGraph = TRUE) %>%
          dySeries("avg", label = "With projected changes",
                   strokeWidth = 2, strokePattern = "dashed") %>%
          dyLegend(width = 400) %>%
          dyEvent(x = "2012-01-22", "Ottawa Starts", labelLoc = "bottom") %>%
          dyEvent(x = "2014-07-01", "Region Starts", labelLoc = "bottom") %>%
          dyEvent(x = "2017-09-30", "Deadline", labelLoc = "bottom") %>%
          dyAnnotation(
            max(per_wk$week), text = "Projected completion",
            tooltip = "Date by which initial assessments could be completed if projected changes were made.",
            width = 80, height = 35
          ) %>%
          dyRangeSelector(dateWindow = c(as.Date(input$dateRange[1]), as.Date(max(per_wk$week))))
        
      })
      
      output$plans <- renderPlotly({
        
        region_filt <- if (input$region == "All") {
          q1_3_person() %>%
            filter(section %in% c("Q3A")) %>%
            select(PIHP) %>% unique() %>% 
            as.list() %>% .$PIHP
        } else input$region

        agency_filt <- if (input$agency == "All") {
          q1_3_person() %>%
            filter(section %in% c("Q3A")) %>%
            select(agency) %>% unique() %>% 
            as.list() %>% .$agency
        } else input$agency

        q1_3_person() %>%
          filter(section %in% c("Q3A")) %>%
          filter(PIHP %in% region_filt & agency %in% agency_filt) %>%
          group_by(fake_id) %>%
          mutate(total = type_n + DST_n + frequency_n) %>%
          select(fake_id, item_desc, total) %>%
          top_n(4) %>%
          ungroup() %>%
          group_by(item_desc) %>%
          summarize(n = n()) %>%
          ungroup() %>%
          # Reorder factor by value for barchart ordering
          mutate(item_desc = fct_reorder(item_desc, .x = n, fun = sum, .desc = T)) %>%
          plot_ly(x = ~item_desc, y = ~n) %>%
          add_bars(color = ~item_desc, colors = "Set3") %>%
          layout(
            xaxis = list(title = "Type of Need", showticklabels = F),
            yaxis = list(title = "# times included in planning"),
            legend = list(
              xanchor = "right", yanchor = "top", 
              x = 1, y = 1, 
              font = list(size = 10)
            ),
            barmode = "stack"
          )
        
      })
      
      output$need_import_q2 <- renderPlotly({
        
        region_filt <- if (input$region == "All") {
          unique(scrub_sis$PIHP)
        } else input$region
        
        agency_filt <- if (input$agency == "All") {
          unique(scrub_sis$agency)
        } else input$agency
        
        filt_input <-
          q1_3_person() %>%
          filter(!section %in% c("Q1A","Q1B","Q3A")) %>%
          filter(
            PIHP %in% region_filt 
            & agency %in% agency_filt
          )
        
        if ( input$import == "All") {
          filt_input <- filt_input 
        } else if ( input$import %in% levels(as.factor(filt_input$importance))) {
          filt_input <- filt_input %>% filter(importance == input$import)
        } else
          print(paste0("Error.  Unrecognized input."))
        
        if ( input$need_import_q2_measure == "Number of people with need" ) {
          filt_input %>%
            mutate(
              no_concern = ifelse(
                importance == "Not endorsed" & type == "None", 
                yes = TRUE, no = FALSE
              )
            ) %>%
            filter(no_concern == F) %>%
            group_by(item_desc,type) %>% # type importance
            summarize(
              n = n_distinct(fake_id),
              avg = round(mean(score, na.rm = T), digits = 1)
            ) %>%
            ungroup() %>% droplevels() %>%
            # Reorder factor by value for barchart ordering
            mutate(
              item_desc = fct_reorder(item_desc, .x = n, fun = sum, .desc = T)
            ) %>%
            plot_ly(x = ~item_desc, y = ~n) %>%
            add_bars(color = ~type, 
                     colors = c("#FF0000", "#00A08A", "#F2AD00", 
                                "#F98400", "#5BBCD6")) %>%
            layout(xaxis = list(title = "Life Domain", showticklabels = F),
                   yaxis = list(title = "People with Need"),
                   legend = list(xanchor = "right", yanchor = "top", x = 1, y = 1, 
                                 font = list(size = 10)),
                   barmode = "stack")
        } else if ( input$need_import_q2_measure == "Average level of need" ) {
          
          filt_input %>%
            mutate(
              no_concern = ifelse(
                importance == "Not endorsed" & type == "None", 
                yes = TRUE, no = FALSE
              )
            ) %>%
            filter(no_concern == F) %>%
            group_by(item_desc) %>% # type importance
            summarize(
              n = n_distinct(fake_id),
              avg = round(mean(score, na.rm = T), digits = 1)
            ) %>%
            ungroup() %>% droplevels() %>%
            # Reorder factor by value for barchart ordering
            mutate(
              item_desc = fct_reorder(item_desc, .x = avg, fun = sum, .desc = T)
            ) %>%
            plot_ly(x = ~item_desc, y = ~avg, type = "bar",  
                    colors = c("#FF0000", "#00A08A", "#F2AD00", 
                               "#F98400", "#5BBCD6")) %>%
            layout(xaxis = list(title = "Life Domain", showticklabels = F),
                   yaxis = list(title = "Average Score"),
                   legend = list(xanchor = "right", yanchor = "top", x = 1, y = 1, 
                                 font = list(size = 10)),
                   barmode = "stack")
        } else
          print(paste0("Error.  Unrecognized input."))
        
      })

      output$import_q2 <- renderPlotly({
        
        region_filt <- if (input$region == "All") {
          unique(scrub_sis$PIHP)
        } else input$region
        
        agency_filt <- if (input$agency == "All") {
          unique(scrub_sis$agency)
        } else input$agency
        
        q1_3_person() %>%
          filter(!section %in% c("Q1A","Q1B","Q3A")) %>%
          filter(PIHP %in% region_filt & agency %in% agency_filt) %>%
          group_by(item_desc) %>%
          summarize(
            To = sum(as.numeric(import_to), na.rm = T),
            For = sum(as.numeric(import_for), na.rm = T)
          ) %>%
          gather(important, n, To:For) %>%
          ungroup() %>%
          # Reorder factor by value for barchart ordering
          mutate(item_desc = fct_reorder(item_desc, .x = n, fun = sum, .desc = T)) %>%
          plot_ly(x = ~item_desc, y = ~n) %>%
          add_bars(color = ~important, colors = c('#b2df8a', '#1f78b4')) %>%
          layout(
            xaxis = list(title = "Life Domain", showticklabels = F),
            yaxis = list(title = "People with need marked as important"),
            legend = list(
              xanchor = "right", yanchor = "top", 
              x = 1, y = 1, 
              font = list(size = 10)
            ),
            barmode = "stack"
          )
        
      })

      output$tos_q2_3 <- renderParset({
        
        tos_parset <-
          q1_3_person() %>%
          # Exclude Section 1 items
          filter(!section %in% c("Q1A","Q1B")) %>%
          group_by(
            PIHP, agency, section_desc, item_desc, 
            type, frequency, DST
          ) %>%
          summarize(
            n = n(),
            type_tot = sum(type_n),
            frequency_tot = sum(frequency_n),
            DST_tot = sum(DST_n)
          ) %>%
          ungroup()
        
        if ( input$agency == "All" & input$region == "All") {
          
          tos_parset %<>% 
            filter(item_desc == input$q2_3domain) %>%
            select(-item_desc,-section_desc) %>%
            group_by(type,frequency,DST,PIHP) %>%
            summarize(n = sum(n)) %>%
            arrange(desc(n))
          
          parset(
            tos_parset,
            # dimensions are the categorical columns
            dimensions = colnames(tos_parset)[-5],
            # use some JavaScript to inform parset that Freq has the value
            value = htmlwidgets::JS("function(d){return d.n}"),
            tension = 0.5,
            width = "80%", height = 400
          )
          
        } else if ( input$region %in% levels(unique(scrub_sis$PIHP)) & input$agency == "All") {
          
          tos_parset %<>% 
            filter(item_desc == input$q2_3domain & PIHP == input$region) %>%
            select(-item_desc,-section_desc) %>%
            group_by(type,frequency,DST,agency) %>%
            summarize(n = sum(n)) %>%
            arrange(desc(n))
          
          parset(
            tos_parset,
            # dimensions are the categorical columns
            dimensions = colnames(tos_parset)[-5],
            # use some JavaScript to inform parset that Freq has the value
            value = htmlwidgets::JS("function(d){return d.n}"),
            tension = 0.5,
            width = "80%", height = 400
          )
          
        } else if ( input$agency %in% levels(unique(scrub_sis$agency)) ) {
          
          tos_parset %<>%  
            filter(agency == input$agency & item_desc == input$q2_3domain) %>%
            group_by(type,frequency,DST) %>%
            summarize(n = sum(n)) %>%
            arrange(desc(n))
          
          parset(
            tos_parset,
            # dimensions are the categorical columns
            dimensions = colnames(tos_parset)[-4],
            # use some JavaScript to inform parset that Freq has the value
            value = htmlwidgets::JS("function(d){return d.n}"),
            tension = 0.5,
            width = "80%", height = 400
          )
        } else
          print(paste0("Error.  Unrecognized input."))
      })

      output$q2_3_dt <- renderDataTable({
        
        filtre <- if (input$select_area_q2_3 == "All") {
          q1_3_person() %>%
            filter(!section %in% c("Q1A","Q1B")) %>%
            select(item_desc) %>% unique() %>% 
            as.list() %>% .$item_desc
        } else 
          q1_3_person() %>%
            filter(!section %in% c("Q1A","Q1B")) %>%
            filter(section_desc == input$select_area_q2_3) %>%
            select(item_desc) %>% unique() %>% 
            as.list() %>% .$item_desc
        
        region_filt <- if (input$region == "All") {
          unique(scrub_sis$PIHP)
        } else input$region
        
        agency_filt <- if (input$agency == "All") {
          unique(scrub_sis$agency)
        } else input$agency
        
        
        if ( input$region == "All" & input$agency == "All" ) {
          
          notescope <- "by Region"
          
          df <-
            q1_3_person() %>%
            filter(!section %in% c("Q1A","Q1B")) %>%
            filter(item_desc %in% filtre) %>%
            group_by(PIHP, item_desc) %>%
            summarize(avg = round(mean(score, na.rm = T), digits = 1)) %>%
            spread(PIHP, avg, drop = FALSE)
          
          dt_in <- 
            q1_3_person() %>%
            filter(!section %in% c("Q1A","Q1B")) %>% 
            filter(item_desc %in% filtre) %>%
            group_by(item_desc) %>%
            summarize(
              avg = round(mean(score, na.rm = T), digits = 1),
              sd = round(sd(score, na.rm = T), digits = 1)
            ) %>% 
            left_join(df, id = "item_desc") %>%
            rename(All = avg, StDev = sd, Item = item_desc) %>%
            arrange(desc(StDev))
          
        } else if ( input$region %in% levels(unique(scrub_sis$PIHP)) & input$agency == "All" ) {
          
          notescope <- paste0("for agencies within ", input$region)
          
          df <- 
            q1_3_person() %>%
            filter(!section %in% c("Q1A","Q1B")) %>%
            filter(PIHP %in% region_filt) %>%
            filter(item_desc %in% filtre) %>%
            group_by(agency, item_desc) %>%
            summarize(avg = round(mean(score, na.rm = T), digits = 1)) %>%
            spread(agency, avg, drop = FALSE)
          
          dt_in <- 
            q1_3_person() %>%
            filter(!section %in% c("Q1A","Q1B")) %>%
            filter(PIHP %in% region_filt) %>%
            filter(item_desc %in% filtre) %>%
            group_by(item_desc) %>%
            summarize(
              avg = round(mean(score, na.rm = T), digits = 1),
              sd = round(sd(score, na.rm = T), digits = 1)
            ) %>% 
            left_join(df, id = "item_desc") %>%
            rename(All = avg, StDev = sd, Item = item_desc) %>%
            arrange(desc(StDev))
          
        } else if ( input$agency %in% levels(unique(scrub_sis$agency)) ) {
          
          notescope <- paste0("at ", input$agency)
          
          df <-
            q1_3_person() %>%
            filter(!section %in% c("Q1A","Q1B")) %>%
            filter(item_desc %in% filtre) %>%
            group_by(agency, item_desc) %>%
            summarize(avg = round(mean(score, na.rm = T), digits = 1)) %>%
            filter(agency == input$agency) %>%
            spread(agency, avg, drop = FALSE)
          
          dt_in <-
            q1_3_person() %>%
            filter(!section %in% c("Q1A","Q1B")) %>%
            filter(item_desc %in% filtre) %>%
            filter(agency != input$agency) %>%
            group_by(item_desc) %>%
            summarize(avg = round(mean(score, na.rm = T), digits = 1)) %>% 
            left_join(df, id = "item_desc") %>%
            mutate(differ = .[[3]] - .[[2]]) %>% # use col indices since names change
            rename(All.Others = avg, Difference = differ, Item = item_desc) %>%
            arrange(desc(Difference))
          
        } else
          print(paste0("Error.  Unrecognized input."))
        
        dt <-
          dt_in %>%
          datatable(
            caption = paste0(
              "Variation and Average Raw Scores on Section 2 Items (",
              input$select_area_q2_3, "), ",notescope
            ),
            rownames = FALSE,
            extensions = c('Responsive','Buttons'),
            options = list(
              pageLength = 5, 
              lengthMenu = c(5, 10,20),
              dom = 'C<"clear">lfrtip',
              buttons = c('colvis')
            )
          ) 
        
        if ( input$agency == "All" ) {
          
          dt %>%
            formatStyle('StDev',
                        background = styleColorBar(dt_in$StDev, 'lightpink'),
                        backgroundSize = '100% 90%',
                        backgroundRepeat = 'no-repeat',
                        backgroundPosition = 'center')
          
        } else if ( input$agency %in% levels(unique(scrub_sis$agency)) ) {  
          
          dt %>%
            formatStyle('Difference',
                        background = styleColorBar(dt_in$Difference, 'lightpink'),
                        backgroundSize = '100% 90%',
                        backgroundRepeat = 'no-repeat',
                        backgroundPosition = 'center')
          
        } else
          print(paste0("Error.  Unrecognized input."))
        
      })
      
      output$hist_sni <- renderPlotly({
        
        if ( input$region == "All" & input$agency == "All" ) {
          notetxt <- "Distribution of scores<br>for Support Needs Index<br>across all regions"
        } else if ( input$region %in% levels(unique(scrub_sis$PIHP)) & input$agency == "All" ) {
          notetxt <- paste0("Distribution of scores<br>for Support Needs Index<br>at ",input$region)
        } else if ( input$agency %in% levels(unique(scrub_sis$agency)) ) {
          notetxt <- paste0("Distribution of scores<br>for Support Needs Index<br>at ",input$agency)
        } else
          print(paste0("Error.  Unrecognized input."))
        
        minx <- min(sisByAgency()$scr_support_needs_index, na.rm = T)
        maxx <- max(sisByAgency()$scr_support_needs_index, na.rm = T)
        sizex <- (maxx - minx) / input$sni_bins
          
        hist <-
          sisByAgency() %>%
          plot_ly(x = ~scr_support_needs_index) %>%
          add_histogram(opacity = 0.6, 
                        autobinx = F,
                        xbins = list(start = minx, 
                                     end = maxx, 
                                     size = sizex),
                        hoverinfo = "all", 
                        name = "people",
                        showlegend = F) %>%
          layout(xaxis = list(title = "Support Needs Index Score", 
                              tickmode = "array",range = c(minx, maxx), autorange = F,
                              autotick = F, tick0 = minx, dtick = sizex),
                 yaxis = list(title = "People assessed", showgrid = F),
                 legend = list(xanchor = "right", yanchor = "top", x = 1, y = 1, 
                               font = list(size = 10)),
                 annotations = list(x = minx, xanchor = "left", 
                                    y = 1, yanchor = "top", yref = "paper",
                                    showarrow = F, align = "left",
                                    text = notetxt)) 
        
        max_hist <- max(hist(sisByAgency()$scr_support_needs_index,
                             breaks = input$sni_bins)$counts,na.rm = TRUE)
        
        ifelse(
          input$central == "Mean",
          yes = hist <- hist %>% add_lines(x = rep(mean(sisByAgency()$scr_support_needs_index, 
                                                        na.rm = T), 
                                                   each = 2), 
                                           y = c(0,max_hist),
                                           line = list(dash = 5),
                                           marker = list(color = "#DA824F"),
                                           name = "Mean score",
                                           hoverinfo = "x",
                                           xaxis = "x"),
          no  = hist <- hist %>% add_lines(x = rep(median(sisByAgency()$scr_support_needs_index, 
                                                          na.rm = T), 
                                                   each = 2), 
                                           y = c(0,max_hist),
                                           line = list(dash = 5),
                                           marker = list(color = "#DA824F"),
                                           name = "Median score",
                                           hoverinfo = "x",
                                           xaxis = "x")
        )
        
        hist
        
      })

      output$norm_sni <- renderPlotly({
        
        # Calculate actual density
        dense <- density(sisByAgency()$scr_support_needs_index, 
                         kernel = "gaussian", 
                         na.rm = T)
        
        # Density of normal distribution
        norm <- density(rnorm(n = nrow(sisByAgency()), mean = 100, sd = 15),
                        kernel = "gaussian", 
                        na.rm = T)
        
        minx <- min(sisByAgency()$scr_support_needs_index, na.rm = T)
        maxx <- max(sisByAgency()$scr_support_needs_index, na.rm = T)
        sizex <- (maxx - minx) / input$norm_bins
        
        sisByAgency() %>%
          plot_ly(x = ~scr_support_needs_index) %>%
          add_histogram(opacity = 0.6,
                        autobinx = F,
                        xbins = list(start = minx, 
                                     end = maxx, 
                                     size = sizex),
                        colors = "#A9A9A9",
                        hoverinfo = "all", 
                        name = "People",
                        yaxis = "y1") %>%
          add_lines(x = dense$x,
                    y = dense$y,
                    name = "Actual Scores",
                    yaxis = "y2") %>%
          add_lines(x = norm$x,
                    y = norm$y,
                    name = "Standard Scores",
                    yaxis = "y2") %>%
          layout(title = "Actual v. Normal Distribution", 
                 yaxis1 = list(title = "People",
                               rangemode = "tozero"),
                 yaxis2 = list(overlaying = "y", 
                               side = "right", 
                               title = "Density",
                               rangemode = "tozero"),
                 xaxis = list(title = "Support Needs Index"))
        
      })
        
      output$dt_sni <- renderDataTable({
        
        clin_by_dom <-
        sisByAgency() %>%
          select(agency = agency,
                 medical = scr_1A_raw_total,
                 behavior = scr_1B_raw_total,
                 homeliving = scr_2A_std,
                 commliving = scr_2B_std,
                 hlthsafety = scr_2E_std,
                 lifelearng = scr_2C_std,
                 employment = scr_2D_std,
                 social = scr_2F_std) %>%
          group_by(agency) %>%
          summarize(n = n(),
                    medical = round(mean(medical, na.rm = T), digits = 1),
                    behavior = round(mean(behavior, na.rm = T), digits = 1),
                    homeliving = round(mean(homeliving, na.rm = T), digits = 1),
                    commliving = round(mean(commliving, na.rm = T), digits = 1),
                    hlthsafety = round(mean(hlthsafety, na.rm = T), digits = 1),
                    lifelearng = round(mean(lifelearng, na.rm = T), digits = 1),
                    employment = round(mean(employment, na.rm = T), digits = 1),
                    social = round(mean(social, na.rm = T), digits = 1)) %>%
          select(agency, medical:social) 
        
        clin_by_dom %>%
          datatable(rownames = FALSE,
                    colnames = c('Agency',
                                 'Medical','Behavioral',
                                 'Home','Community','Safety',
                                 'Learning','Employment', 'Social'),
                    caption = 'Average subscale scores by Agency',
                    extensions = c('Responsive','Buttons'),
                    options = list(pageLength = 10, 
                                   lengthMenu = c(5,10,nrow(clin_by_dom)),
                                   dom = 'C<"clear">lfrtip',
                                   buttons = c('colvis'))) %>%
          formatStyle('medical',
                      background = styleColorBar(clin_by_dom$medical, 'lightseagreen'),
                      backgroundSize = '100% 90%',
                      backgroundRepeat = 'no-repeat',
                      backgroundPosition = 'center') %>%
          formatStyle('behavior',
                      background = styleColorBar(clin_by_dom$behavior, 'lightsteelblue'),
                      backgroundSize = '100% 90%',
                      backgroundRepeat = 'no-repeat',
                      backgroundPosition = 'center') %>%
          formatStyle('homeliving',
                      background = styleColorBar(clin_by_dom$homeliving, 'lightblue'),
                      backgroundSize = '100% 90%',
                      backgroundRepeat = 'no-repeat',
                      backgroundPosition = 'center') %>%
          formatStyle('commliving',
                      background = styleColorBar(clin_by_dom$commliving, 'steelblue'),
                      backgroundSize = '100% 90%',
                      backgroundRepeat = 'no-repeat',
                      backgroundPosition = 'center') %>%
          formatStyle('hlthsafety',
                      background = styleColorBar(clin_by_dom$hlthsafety, 'darkseagreen'),
                      backgroundSize = '100% 90%',
                      backgroundRepeat = 'no-repeat',
                      backgroundPosition = 'center') %>%
          formatStyle('lifelearng',
                      background = styleColorBar(clin_by_dom$lifelearng, 'darkcyan'),
                      backgroundSize = '100% 90%',
                      backgroundRepeat = 'no-repeat',
                      backgroundPosition = 'center') %>%
          formatStyle('employment',
                      background = styleColorBar(clin_by_dom$employment, 'mediumturquoise'),
                      backgroundSize = '100% 90%',
                      backgroundRepeat = 'no-repeat',
                      backgroundPosition = 'center') %>%
          formatStyle('social',
                      background = styleColorBar(clin_by_dom$social, 'mediumaquamarine'),
                      backgroundSize = '100% 90%',
                      backgroundRepeat = 'no-repeat',
                      backgroundPosition = 'center')
        
      })
      
      output$conditions <- renderPlotly({
        
        radio <- if (input$radio_mb == "Either") {c("Medical Supports","Behavioral Supports")
        } else if (input$radio_mb == "Medical") {c("Medical Supports")
        } else if (input$radio_mb == "Behavioral") {c("Behavioral Supports")
        } else print(paste0("Error.  Unrecognized input."))
        
        region_filt <- if (input$region == "All") {
          q1_3_person() %>%
          filter(section %in% c("Q1A","Q1B")) %>%
            select(PIHP) %>% unique() %>% 
            as.list() %>% .$PIHP
        } else input$region
        
        agency_filt <- if (input$agency == "All") {
          q1_3_person() %>%
          filter(section %in% c("Q1A","Q1B")) %>%
            select(agency) %>% unique() %>% 
            as.list() %>% .$agency
        } else input$agency
        
        q1_3_person() %>%
          filter(section %in% c("Q1A","Q1B")) %>%
          filter(PIHP %in% region_filt & agency %in% agency_filt) %>%
          filter(score > 0 & section_desc %in% radio) %>%
          group_by(item_desc,level) %>%
          summarize(n = n()) %>%
          ungroup() %>%
          # Reorder factor by value for barchart ordering
          mutate(item_desc = fct_reorder(item_desc, .x = n, fun = sum, .desc = T)) %>%
          plot_ly(x = ~item_desc, y = ~n) %>%
          add_bars(color = ~level, colors = c("#F98400","#FF0000")) %>%
          layout(
            xaxis = list(title = "Type of Need", showticklabels = F),
            yaxis = list(title = "People with need"),
            legend = list(
              xanchor = "right", yanchor = "top", 
              x = 1, y = 1, 
              font = list(size = 10)
            ),
            barmode = "stack"
          )
        
      })

      output$hist_mb <- renderPlotly({
        
        if ( input$region == "All" & input$agency == "All" ) {
          notescope <- "across all CMHSPs"
        } else if ( input$region %in% levels(unique(scrub_sis$PIHP)) & input$agency == "All" ) {
          notescope <- paste0("in ",input$region)
        } else if ( input$agency %in% levels(unique(scrub_sis$agency)) ) {
          notescope <- paste0("at ",input$agency)
        } else
          print(paste0("Error.  Unrecognized input."))
        
        if ( input$radio_mb == "Medical" ) {
          notetxt <- paste0("Distribution of needs<br>for medical issues<br>",
                            notescope)
          
          minx <- min(sisByAgency()$scr_1A_raw_total, na.rm = T)
          maxx <- max(sisByAgency()$scr_1A_raw_total, na.rm = T)
          sizex <- (maxx - minx) / input$mb_bins
          
          max_hist <- max(hist(sisByAgency()$scr_1A_raw_total,
                               breaks=input$mb_bins)$counts,na.rm = T)
          
          hist <-
            sisByAgency() %>%
            plot_ly(x = ~scr_1A_raw_total) %>%
            add_histogram(opacity = 0.6, 
                          autobinx = F,
                          xbins = list(start = minx, 
                                       end = maxx, 
                                       size = sizex),
                          hoverinfo = "all",  
                          name = "people",
                          showlegend = F) %>%
            layout(xaxis = list(title = "Number of medical needs", 
                                tickmode = "array",
                                range = c(minx, maxx), 
                                autorange = F,
                                autotick = F, 
                                tick0 = minx, dtick = sizex),
                   yaxis = list(title = "People assessed", showgrid = F),
                   annotations = list(x = maxx, xanchor = "right", 
                                      y = 1, yanchor = "top", yref = "paper",
                                      showarrow = F, align = "left",
                                      text = notetxt)) %>% 
            add_lines(x = rep(mean(sisByAgency()$scr_1A_raw_total, na.rm = T), 
                              each = 2), 
                      y = c(0,max_hist),
                      line = list(dash = 5),
                      #marker = list(color = "#DA824F"),
                      name = "Mean",
                      hoverinfo = "x",
                      xaxis = "x")
          
        } else if ( input$radio_mb == "Behavioral" ) {
          
          notetxt <- paste0("Distribution of needs<br>for behavioral issues<br>",
                            notescope)
          
          minx <- min(sisByAgency()$scr_1B_raw_total, na.rm = T)
          maxx <- max(sisByAgency()$scr_1B_raw_total, na.rm = T)
          sizex <- (maxx - minx) / input$mb_bins
          
          max_hist <- max(hist(sisByAgency()$scr_1B_raw_total,
                               breaks=input$mb_bins)$counts,na.rm=TRUE)
          
          hist <-
            sisByAgency() %>%
            plot_ly(x = ~scr_1B_raw_total) %>%
            add_histogram(opacity = 0.6, 
                          autobinx = F,
                          xbins = list(start = minx, 
                                       end = maxx, 
                                       size = sizex),
                          hoverinfo = "all",  
                          name = "people",
                          showlegend = F) %>%
            layout(xaxis = list(title = "Number of behavioral needs", 
                                tickmode = "array",
                                range = c(minx, maxx), 
                                autorange = F,
                                autotick = F, 
                                tick0 = minx, 
                                dtick = sizex),
                   yaxis = list(title = "People assessed", showgrid = F),
                   annotations = list(x = maxx, xanchor = "right", 
                                      y = 1, yanchor = "top", yref = "paper",
                                      showarrow = F, align = "left",
                                      text = notetxt)) %>% 
            add_lines(x = rep(mean(sisByAgency()$scr_1B_raw_total, na.rm = T), 
                              each = 2), 
                      y = c(0,max_hist),
                      line = list(dash = 5),
                      #marker = list(color = "#DA824F"),
                      name = "Mean",
                      hoverinfo = "x",
                      xaxis = "x")
          
        } else if ( input$radio_mb == "Either" ) {
          
          notetxt <- paste0("Distribution of needs<br>for both medical issues<br>and behavioral issues<br>",
                            notescope)
          
          minx <- min(sisByAgency()$scr_1A_raw_total, sisByAgency()$scr_1B_raw_total, na.rm = T)
          maxx <- max(sisByAgency()$scr_1A_raw_total, sisByAgency()$scr_1B_raw_total, na.rm = T)
          sizex <- (maxx - minx) / input$mb_bins
          
          max_hist <- max(hist(sisByAgency()$scr_1A_raw_total,
                               breaks=input$mb_bins)$counts
                          + hist(sisByAgency()$scr_1B_raw_total,
                                 breaks=input$mb_bins)$counts,
                          na.rm = T)
          
          hist <-
            sisByAgency() %>%
            plot_ly(x = ~(scr_1A_raw_total + scr_1B_raw_total)) %>%
            add_histogram(opacity = 0.6, 
                          autobinx = F,
                          xbins = list(start = minx, 
                                       end = maxx, 
                                       size = sizex),
                          hoverinfo = "all",  
                          name = "people",
                          showlegend = F) %>%
            layout(xaxis = list(title = "Combined medical and behavioral needs (per person)", 
                                tickmode = "array",
                                range = c(minx, maxx), 
                                autorange = F,
                                autotick = F, 
                                tick0 = minx, dtick = sizex),
                   yaxis = list(title = "People assessed", showgrid = F),
                   annotations = list(x = maxx, xanchor = "right", 
                                      y = 1, yanchor = "top", yref = "paper",
                                      showarrow = F, align = "left",
                                      text = notetxt)) %>% 
            add_lines(x = rep(mean(sisByAgency()$scr_1A_raw_total), 
                              each = 2), 
                      y = c(0,max_hist),
                      line = list(dash = 5),
                      #marker = list(color = "#DA824F"),
                      name = "Mean",
                      hoverinfo = "x",
                      xaxis = "x")
        } else
          print(paste0("Error.  Unrecognized input."))
         
        hist
        
      })
      
      output$box_int <- renderPlotly({
        
        # Make an interviewer key
        box_df <- boxInput() 
        int_nm <- unique(box_df$interviewer)
        int_id <- c() #create an empty vec
        n <- 1 # Set initial num
        for (i in unique(box_df$interviewer)) {
          int_id <- c(int_id,
                      paste0("Interviewer ", 
                             as.character(n)))
          n <- n + 1
        }
        int_df <- data.frame(int_nm)
        int_df <- int_df %>% arrange(int_nm)
        int_df$int_id <- as.factor(int_id)
        rm(int_id); rm(int_nm)
        
        if(input$region == "All" & input$agency == "All") {
          
          boxInput() %>%
            plot_ly(x = ~score, color = ~subscale, type = "box") %>%
            plotly::layout(yaxis = list(title = "Subscale",
                                        showticklabels = F))
          
        } else
        
        
        boxInput() %>%
          left_join(int_df, by = c("interviewer" = "int_nm")) %>%
          filter(subscale == input$box) %>%
          plot_ly(x = ~score, color = ~int_id, type = "box") %>%
          plotly::layout(yaxis = list(title = "Interviewers",
                                      showticklabels = F))
          
      })
      
      output$int_prod <- renderPlotly({
        
        if (input$metric == "% of Total") {
          
          is_current <- if (input$is_current == "Current assessors") {
            c(TRUE)
          } else if (input$is_current == "All Assessors") {
            c(TRUE, FALSE)
          } else print(paste0("Error.  Unrecognized input."))
          
          max_y <- max(interviewer_wk()$pct, na.rm = T) + max(interviewer_wk()$pct*.1)
          
          interviewer_wk() %>%
            filter(current_int %in% is_current) %>%
            plot_ly(x = ~week, y = ~pct, color = ~interviewer,
                    hoverinfo = 'text',
                    text = ~paste(pct, "percent of assessments were completed by",
                                  interviewer, "in the week of",week)) %>%
            add_lines(y = ~pct) %>%
            layout(
              title = "% of Assessments",
              xaxis = list(
                title = "Week",
                rangeselector = list(
                  buttons = list(
                    list(
                      count = 2,
                      label = "2 mo",
                      step = "month",
                      stepmode = "backward"),
                    list(
                      count = 6,
                      label = "6 mo",
                      step = "month",
                      stepmode = "backward"),
                    list(
                      count = 1,
                      label = "1 yr",
                      step = "year",
                      stepmode = "backward"),
                    list(
                      count = 1,
                      label = "YTD",
                      step = "year",
                      stepmode = "todate"),
                    list(
                      label = "All",
                      step = "all")
                    )),
                
                rangeslider = list(type = "date")
              ),
              
              yaxis = list(title = "Percent of Total Assessments Completed",
                           range = c(0, max_y)))
          
        } else if(input$metric == "Average Minutes"){
          
          is_current <- if (input$is_current == "Current assessors") {
            c(TRUE)
          } else if (input$is_current == "All Assessors") {
            c(TRUE, FALSE)
          } else print(paste0("Error.  Unrecognized input."))
          
          max_y <- max(interviewer_wk()$avg_dur, na.rm = T)+max(interviewer_wk()$avg_dur*.1)
          
          interviewer_wk() %>%
            filter(current_int %in% is_current) %>%
            plot_ly(x = ~week, y= ~avg_dur, color = ~interviewer,
                    hoverinfo = 'text',
                    text = ~paste(interviewer, "spent an average of", avg_dur,
                                  "minutes per assessment in the week of",week)) %>%
            add_lines(y = ~avg_dur) %>%
            layout(
              title = "Average Minutes",
              xaxis = list(
                title = 'Week',
                           rangeselector = list(
                             buttons = list(
                               list(
                                 count = 2,
                                 label = "2 mo",
                                 step = "month",
                                 stepmode = "backward"),
                               list(
                                 count = 6,
                                 label = "6 mo",
                                 step = "month",
                                 stepmode = "backward"),
                               list(
                                 count = 1,
                                 label = "1 yr",
                                 step = "year",
                                 stepmode = "backward"),
                               list(
                                 count = 1,
                                 label = "YTD",
                                 step = "year",
                                 stepmode = "todate"),
                               list(
                                 label = "All",
                                 step = "all")
                               )),
                           
                           rangeslider = list(type = "date")
                           ),
              
              yaxis = list(title = 'Minutes per Assessment',
                           range = c(0, max_y)))
          
        } else if(input$metric == "# of Assessments"){
          
          is_current <- if (input$is_current == "Current assessors") {
            c(TRUE)
          } else if (input$is_current == "All Assessors") {
            c(TRUE, FALSE)
          } else print(paste0("Error.  Unrecognized input."))
          
          max_y <- max(interviewer_wk()$n, na.rm = T)+max(interviewer_wk()$n*.1)
          
          interviewer_wk() %>%
            filter(current_int %in% is_current) %>%
            plot_ly(x = ~week, y= ~n, color = ~interviewer,
                    hoverinfo = 'text',
                    text = ~paste(n, "assessments were completed by",
                                  interviewer, "in the week of",week)) %>%
            add_lines(y = ~n) %>%
            layout(
              title = "Number of Assessments",
              xaxis = list(title = 'Week',
                           rangeselector = list(
                             buttons = list(
                               list(
                                 count = 2,
                                 label = "2 mo",
                                 step = "month",
                                 stepmode = "backward"),
                               list(
                                 count = 6,
                                 label = "6 mo",
                                 step = "month",
                                 stepmode = "backward"),
                               list(
                                 count = 1,
                                 label = "1 yr",
                                 step = "year",
                                 stepmode = "backward"),
                               list(
                                 count = 1,
                                 label = "YTD",
                                 step = "year",
                                 stepmode = "todate"),
                               list(
                                 label = "All",
                                 step = "All")
                               )),
                             
                             rangeslider = list(type = "date")
              ),
              
              yaxis = list(title = 'Assessments Completed',
                           range = c(0, max_y)))
          
        }
        
      })
      
      output$cor_matrix <- renderPlotly({
        
        withProgress(
          message = 'Calculating...',
          detail = 'correlation matrix',
          value = 0.1, 
          {
            corr_df() %>%
              correlate() %>%
              rearrange() %>%
              shave(upper = T) %>%
              as_matrix() %>%
              t() %>%
              plot_ly(
                x = colnames(.), y = row.names(.), z = .
              ) %>% 
              add_heatmap(
                colors = colorRampPalette(c("#de2d26","white","#08519c"))(256),
                name = "Related Life Areas"
              ) %>%
              colorbar(
                title = "Correlation coefficient",
                limits = c(-1, 1)
              ) %>%
              layout(
                title = "",
                margin = list(l = 200, b = 160),
                xaxis = list(title = "Item", tickangle = 45, showgrid = F),
                yaxis = list(title = "", showgrid = F)
              )
          }
        )
        
      })
      
      output$par_coords <- renderParcoords({
        
        corr_df() %>%
          parcoords(
            rownames = F,
            brushMode = "multi" , #"2D-strums", 
            reorderable = T, 
            queue = T,
            color = list(
              colorScale = htmlwidgets::JS('d3.scale.category20b()' ),
              colorBy = input$color_parcoord
            ),
            tasks = list(
              'function(){
              d3.select(this.el).selectAll(".dimension:nth-child(n+1) > .axis > text")
              //translate down and to right assuming will need more room
              //     but this might remove our handle for reorderable if brush is on
              //rotate -90 so vertical, but -45 might be better with translate(-5,-5)
              .attr("transform","translate(15,15) rotate(-45)") // changed translate to line up
              .style("text-anchor", "start") //  can be start middle or end
              }'
            )
          )
        
      })
      
      output$scatter_vars <- renderPlotly({

        withProgress(
          message = 'Making a plot...',
          detail = 'just for you',
          value = 0.1, 
          {
            p <-
              corr_df() %>%
              select(
                x_var = matches(input$scatter_vars_x),
                y_var = matches(input$scatter_vars_y)
              ) %>%
              filter(complete.cases(.)) %>%
              ungroup()
            
            # l <- msir::loess.sd(p, nsigma = 1.96)
            
            q <- p %>%
              plot_ly(x = ~x_var, y = ~y_var) %>%
              layout(
                xaxis = list(
                  title = input$scatter_vars_x,
                  showgrid = F
                ),
                yaxis = list(
                  title = input$scatter_vars_y,
                  showgrid = F
                )
              )
            
            if (input$scatter_viz_type == "Scatterplot") {

              q %>%
                add_markers(showlegend = FALSE) %>%
                add_lines(
                  y = ~fitted(loess(y_var ~ x_var)),
                  line = list(color = '#0a4f75'),
                  name = "LOESS Smoother"
                )
              # add_lines(l$x, l$upper,
              #           line = list(color = '#0a4f75', dash = "dash"),
              #           fill = 'None', showlegend = FALSE) %>%
              # add_lines(l$x, l$lower,
              #           line = list(color = '#0a4f75', dash = "dash"),
              #           name = "Standard Error", fill = 'tonexty')
              
            } else if (input$scatter_viz_type == "Contour plot") {
              q %>% add_histogram2dcontour()
            }

            
## ggplot            
            # p <-
            # corr_df() %>%
            #   select(
            #     x_var = matches(input$scatter_vars_x),
            #     y_var = matches(input$scatter_vars_y)
            #   ) %>%
            #   filter(complete.cases(.)) %>%
            #   ungroup()
            # 
            # if (input$scatter_viz_type == "Scatterplot") {
            #   
            #   p %>%
            #     ggplot(aes(x_var, y_var)) + 
            #     geom_point(shape = 1,
            #                position = position_jitter(width = 1, height = 0.5)) + 
            #     geom_smooth() +
            #     labs(
            #       x = input$scatter_vars_x,
            #       y = input$scatter_vars_y
            #     ) +
            #     theme(panel.background = element_rect(fill = 'white'))
            # 
            # } else if (input$scatter_viz_type == "Contour plot") {
            #   
            #   p %>%
            #     plot_ly(x = ~x_var, y = ~y_var) %>%
            #     layout(
            #       xaxis = list(
            #         title = input$scatter_vars_x,
            #         showgrid = F
            #       ),
            #       yaxis = list(
            #         title = input$scatter_vars_y,
            #         showgrid = F
            #       )
            #     ) %>% 
            #     add_histogram2dcontour()
            # }

          }
        )

      })
      
      output$ipos_need <- renderDataTable({
        
        withProgress(message = 'Checking...',
                     detail = 'personal preferences',
                     value = 0.1, 
                     {
                       DT_in <- ind_svs()
                       
                       # Display Section or QOL area based on user input
                       if ( input$pick_dom == "SIS Section") {
                         DT_in %<>% rename(domain = section_desc)
                       } else if (input$pick_dom == "QOL Domain") {
                         DT_in %<>% rename(domain = qol)
                       } else
                         print(paste0("Error.  Unrecognized input."))
                       
                       DT_in %>%
                         filter(!grepl("^Q1",section)) %>% # Exclude Section 1 items
                         arrange(domain,desc(score)) %>%
                         ungroup() %>%
                         select(domain,item_desc,score,
                                type,frequency,DST,importance) %>%
                         distinct(.keep_all = T) %>%
                         datatable(
                           rownames = F,
                           colnames = c('Area','Need','Score',
                                        'Type of Support','Frequency','Daily Support Time',
                                        'Important To/For'),
                           options = list(pageLength = nrow(DT_in),
                                          dom = 't')
                         ) %>%
                         formatStyle(
                           'score',
                           color = styleInterval(c(6), c("#800026","#ffffcc")),
                           backgroundColor = styleInterval(c(1:8), brewer.pal(9,"YlOrRd")) 
                         )
                       
                     })
        
      })
      
      output$ipos_mb <- renderDataTable({
        
        withProgress(message = 'Identifying...',
                     detail = 'personal needs',
                     value = 0.1, 
                     {
                       DT_in <- 
                         q1_3_person() %>% 
                         filter(section %in% c("Q1A","Q1B")) %>%
                         filter(fake_id == rand_id())
                       
                       # Display Section or QOL area based on user input
                       if ( input$pick_dom == "SIS Section") {
                         DT_in %<>% rename(domain = section_desc)
                       } else if (input$pick_dom == "QOL Domain") {
                         DT_in %<>% rename(domain = qol)
                       } else
                         print(paste0("Error.  Unrecognized input."))
                       
                       DT_in %>% 
                         group_by(fake_id) %>%
                         filter(as.Date(sis_date) == max(as.Date(sis_date))) %>%
                         filter(grepl("^Q1",section)) %>% # Include only Section 1 items
                         filter(score > 0) %>%
                         arrange(domain,desc(score)) %>%
                         ungroup() %>%
                         select(domain,item_desc,score,level) %>%
                         datatable(
                           rownames = F,
                           colnames = c('Area','Need','Score','Type of Support'),
                           options = list(pageLength = nrow(DT_in),dom = 't')
                         ) %>%
                         formatStyle(
                           'score',
                           color = styleInterval(c(6), c("#800026","#ffffcc")),
                           backgroundColor = styleInterval(c(1:8), brewer.pal(9,"YlOrRd"))
                         ) %>%
                         formatStyle(
                           'level', 
                           color = styleEqual(c("Some Support Needed","Extensive Support Needed"), 
                                              c("#800026", "#fc4e2a")),
                           fontWeight = styleEqual(c("Some Support Needed","Extensive Support Needed"), 
                                                   c('bold', 'bold'))
                         )
                     })

      })
      
      output$ipos_pccls <- renderDataTable({
        
        withProgress(message = 'Listing...',
                     detail = 'needs for PC/CLS',
                     value = 0.1, 
                     {
                       pccls <- svs2sis(c("T1020","H2016"))
                       
                       DT_in <- 
                         q1_3_person() %>%
                         mutate(
                           type = ifelse(
                             section %in% c("Q1A","Q1B"),
                             yes = level, no = type
                           )
                         ) %>%
                         select(-level) %>% 
                         filter(fake_id == rand_id()) %>%
                         group_by(fake_id) %>%
                         filter(as.Date(sis_date) == max(as.Date(sis_date))) %>%
                         filter(item %in% pccls$item) %>%
                         filter(need_svc == T) %>%  
                         filter(score > 0) %>%
                         arrange(desc(score)) %>%
                         ungroup()
                       
                       if ( input$pick_dom == "SIS Section") {
                         DT_in %<>% rename(area = section_desc)
                       } else if (input$pick_dom == "QOL Domain") {
                         DT_in %<>% rename(area = qol)
                       } else print(paste0("Error.  Unrecognized input."))
                       
                       DT_in %>%
                         select(frequency,DST,type,score,area,item_desc) %>%
                         datatable(
                           rownames = F,
                           colnames = c('Frequency','Daily Support Time','Type of Support',
                                        'Score','Area','Need'),
                           options = list(pageLength = nrow(DT_in),
                                          dom = 't')
                         ) %>%
                         formatStyle(
                           'type', 
                           fontWeight = styleEqual(c("Some Support Needed","Extensive Support Needed"), 
                                                   c('bold', 'bold'))
                         )
                     })
        
      })
      
      output$ipos_dcsn <- renderDataTable({
        
        withProgress(
          message = 'Checking...',
          detail = 'personal preferences',
          value = 0.1, 
          {
            # filtering for random individual
            DT_in <- q1_3_person() %>% filter(fake_id == rand_id())
            
            # calculating score percentiles
            DT_in_p <- q1_3_person() %>% 
              filter(dcsn_flg %in% c('p','s')) %>%
              select(fake_id,item,score) %>%
              distinct(.keep_all = T) %>%
              group_by(fake_id,item) %>%
              summarize(score = sum(score)) %>%
              spread(item, score) %>%
              ungroup() %>%
              mutate(
                `Recreation` = ecdf(Q2B2_)(Q2B2_),
                `Preferred Activities` = ecdf(Q2B3_)(Q2B3_),
                `Visit Friends/Family` = ecdf(Q2B8_)(Q2B8_),
                `Learning problem-solving` = ecdf(Q2C1_)(Q2C1_),
                `Learning self-determination` = ecdf(Q2C4_)(Q2C4_),
                `Educational decisions` = ecdf(Q2C6_)(Q2C6_),
                `Obtaining health care` = ecdf(Q2E4_)(Q2E4_),
                `Communicating needs` = ecdf(Q2F7_)(Q2F7_),
                `Self-advocacy` = ecdf(Q3A1_)(Q3A1_),
                `Decision making` = ecdf(Q3A2_)(Q3A2_),
                `Civic responsibility` = ecdf(Q3A4_)(Q3A4_),
                `Advocating for others` = ecdf(Q3A8_)(Q3A8_)
              ) %>%
              filter(fake_id == rand_id()) %>%
              select(`Recreation`:`Advocating for others`)
            
            DT_in_p <- data.frame(t(DT_in_p))
            DT_in_p$item_desc <- rownames(DT_in_p)
                       
            # Display Section or QOL area based on user input
            if ( input$pick_dom == "SIS Section") {
              DT_in %<>% rename(domain = section_desc)
            } else if (input$pick_dom == "QOL Domain") {
              DT_in %<>% rename(domain = qol)
            } else print(paste0("Error.  Unrecognized input."))
                       
            DT_in %>%
              filter(!grepl("^Q1",section)) %>% # Exclude Section 1 items
              filter(dcsn_flg %in% c('p','s')) %>%
              arrange(domain,desc(score)) %>%
              ungroup() %>%
              left_join(DT_in_p, by = "item_desc") %>%
              select(domain,item_desc,score,t.DT_in_p.,type,frequency,DST,importance) %>%
              distinct(.keep_all = T) %>%
              datatable(
                rownames = F,
                colnames = c(
                  'Area','Need','Score','Percentile','Type of Support','Frequency',
                  'Daily Support Time','Important To/For'
                ),
                options = list(pageLength = nrow(DT_in), dom = 't')
              ) %>%
              formatStyle(
                'score',
                color = styleInterval(c(6), c("#800026","#ffffcc")),
                backgroundColor = styleInterval(c(1:8), brewer.pal(9,"YlOrRd")) 
              ) %>%
              formatStyle(
                't.DT_in_p.',
                background = styleColorBar(DT_in_p$t.DT_in_p., 'grey'),
                backgroundSize = '100% 90%',
                backgroundRepeat = 'no-repeat',
                backgroundPosition = 'center'
              ) %>%
              formatPercentage('t.DT_in_p.')
              
          })
        
      })
      
      DT_in <- reactive({
        
        # randomly selected individual
        DT_in <- q1_3_person() %>% 
          filter(fake_id == rand_id(),
                 dcsn_flg == 'p') %>%
          select(fake_id,item,score) %>%
          distinct(.keep_all = T) %>%
          group_by(fake_id,item) %>%
          summarize(score = sum(score)) %>%
          spread(item, score)
        
      })
      
      output$ipos_dcsnPlot1 <- renderPlotly({
        
            # create plot
            q1_3_person() %>%
              filter(!grepl("^Q1",section), # Exclude Section 1 items
                     is.na(score) == F,
                     dcsn_flg == 'p') %>%
              select(fake_id,item,score) %>%
              distinct(.keep_all = T) %>%
              group_by(fake_id,item) %>%
              summarize(score = sum(score)) %>%
              spread(item, score) %>%
              plot_ly(
                x = ~Q2C1_, y = ~Q2C4_,
                type = "scatter", mode = "markers",
                hoverinfo = 'text',
                text = ~paste('Learning Problem Solving: ',q1_3_person()$Q2C1_,'<br>',
                              'Learning Self-Determination: ', q1_3_person()$Q2C4_)
              ) %>%
              layout(
                xaxis = list(title = "Learning Problem Solving", range = c(0,25)),
                yaxis = list(title = "Learning Self-Determination", range = c(0,25)),
                annotations = list(
                  list(
                    x = DT_in()$Q2C1_,
                    y = DT_in()$Q2C4_,
                    text = 'Selected Individual',
                    xref = "x",
                    yref = "y",
                    font = list(color = '#000000',
                                size = 16),
                    bgcolor = '#c7c7c7'
                    
                  )
                )
              )
        
      })
      
      output$ipos_dcsnPlot2 <- renderPlotly({

            # create plot
            q1_3_person() %>%
              filter(!grepl("^Q1",section), # Exclude Section 1 items
                     is.na(score) == F,
                     dcsn_flg == 'p') %>%
              select(fake_id,item,score) %>%
              distinct(.keep_all = T) %>%
              group_by(fake_id,item) %>%
              summarize(score = sum(score)) %>%
              spread(item, score) %>%
              plot_ly(
                x = ~Q2C1_, y = ~Q3A2_,
                type = "scatter", mode = "markers",
                hoverinfo = 'text',
                text = ~paste('Learning Problem Solving: ',q1_3_person()$Q2C1_,'<br>',
                              'Decision Making: ', q1_3_person()$Q3A2_)
              ) %>%
              layout(
                xaxis = list(title = "Learning Problem Solving", range = c(0,25)),
                yaxis = list(title = "Decision Making", range = c(0,25)),
                annotations = list(
                  list(
                    x = DT_in()$Q2C1_,
                    y = DT_in()$Q3A2_,
                    text = 'Selected Individual',
                    xref = "x",
                    yref = "y",
                    font = list(color = '#000000',
                                size = 16),
                    bgcolor = '#c7c7c7'
                  )
                )
              )
        
      })
      
      output$ipos_dcsnPlot3 <- renderPlotly({
        
        # create plot
        q1_3_person() %>%
          filter(!grepl("^Q1",section), # Exclude Section 1 items
                 is.na(score) == F,
                 dcsn_flg == 'p') %>%
          select(fake_id,item,score) %>%
          distinct(.keep_all = T) %>%
          group_by(fake_id,item) %>%
          summarize(score = sum(score)) %>%
          spread(item, score) %>%
          plot_ly(
            x = ~Q2C1_, y = ~Q3A1_,
            type = "scatter", mode = "markers",
            hoverinfo = 'text',
            text = ~paste('Learning Problem Solving: ',q1_3_person()$Q2C1_,'<br>',
                          'Self-Advocacy: ', q1_3_person()$Q3A1_)
          ) %>%
          layout(
            xaxis = list(title = "Learning Problem Solving", range = c(0,25)),
            yaxis = list(title = "Self-Advocacy", range = c(0,25)),
            annotations = list(
              list(
                x = DT_in()$Q2C1_,
                y = DT_in()$Q3A1_,
                text = 'Selected Individual',
                xref = "x",
                yref = "y",
                font = list(color = '#000000',
                            size = 16),
                bgcolor = '#c7c7c7'
              )
            )
          )
        
      })
      
      output$ipos_dcsnPlot4 <- renderPlotly({
        
        # create plot
        q1_3_person() %>%
          filter(!grepl("^Q1",section), # Exclude Section 1 items
                 is.na(score) == F,
                 dcsn_flg == 'p') %>%
          select(fake_id,item,score) %>%
          distinct(.keep_all = T) %>%
          group_by(fake_id,item) %>%
          summarize(score = sum(score)) %>%
          spread(item, score) %>%
          plot_ly(
            x = ~Q2C4_, y = ~Q3A2_,
            type = "scatter", mode = "markers",
            hoverinfo = 'text',
            text = ~paste('Learning Self-Determination: ',q1_3_person()$Q2C4_,'<br>',
                          'Decision Making: ', q1_3_person()$Q3A2_)
          ) %>%
          layout(
            xaxis = list(title = "Learning Self-Determination", range = c(0,25)),
            yaxis = list(title = "Decision Making", range = c(0,25)),
            annotations = list(
              list(
                x = DT_in()$Q2C4_,
                y = DT_in()$Q3A2_,
                text = 'Selected Individual',
                xref = "x",
                yref = "y",
                font = list(color = '#000000',
                            size = 16),
                bgcolor = '#c7c7c7'
              )
            )
          )
        
      })
      
      output$ipos_dcsnPlot5 <- renderPlotly({
        
        # create plot
        q1_3_person() %>%
          filter(!grepl("^Q1",section), # Exclude Section 1 items
                 is.na(score) == F,
                 dcsn_flg == 'p') %>%
          select(fake_id,item,score) %>%
          distinct(.keep_all = T) %>%
          group_by(fake_id,item) %>%
          summarize(score = sum(score)) %>%
          spread(item, score) %>%
          plot_ly(
            x = ~Q2C4_, y = ~Q3A1_,
            type = "scatter", mode = "markers",
            hoverinfo = 'text',
            text = ~paste('Learning Self-Determination: ',q1_3_person()$Q2C4_,'<br>',
                          'Self-Advocacy: ', q1_3_person()$Q3A1_)
          ) %>%
          layout(
            xaxis = list(title = "Learning Self-Determination", range = c(0,25)),
            yaxis = list(title = "Self-Advocacy", range = c(0,25)),
            annotations = list(
              list(
                x = DT_in()$Q2C4_,
                y = DT_in()$Q3A1_,
                text = 'Selected Individual',
                xref = "x",
                yref = "y",
                font = list(color = '#000000',
                            size = 16),
                bgcolor = '#c7c7c7'
              )
            )
          )
        
      })
      
      output$ipos_dcsnPlot6 <- renderPlotly({
        
        # create plot
        q1_3_person() %>%
          filter(!grepl("^Q1",section), # Exclude Section 1 items
                 is.na(score) == F,
                 dcsn_flg == 'p') %>%
          select(fake_id,item,score) %>%
          distinct(.keep_all = T) %>%
          group_by(fake_id,item) %>%
          summarize(score = sum(score)) %>%
          spread(item, score) %>%
          plot_ly(
            x = ~Q3A1_, y = ~Q3A2_,
            type = "scatter", mode = "markers",
            hoverinfo = 'text',
            text = ~paste('Self-Advocacy: ',q1_3_person()$Q3A1_,'<br>',
                          'Decision Making: ', q1_3_person()$Q3A2_)
          ) %>%
          layout(
            xaxis = list(title = "Self-Advocacy", range = c(0,25)),
            yaxis = list(title = "Decision Making", range = c(0,25)),
            annotations = list(
              list(
                x = DT_in()$Q3A1_,
                y = DT_in()$Q3A2_,
                text = 'Selected Individual',
                xref = "x",
                yref = "y",
                font = list(color = '#000000',
                            size = 16),
                bgcolor = '#c7c7c7'
              )
            )
          )
        
      })
      
      output$dcsn_Plots <- renderUI({
        
        fluidRow(
          column(
            width = 4,
            plotlyOutput("ipos_dcsnPlot1"),
            plotlyOutput("ipos_dcsnPlot4")
          ),
          column(
            width = 4,
            plotlyOutput("ipos_dcsnPlot2"),
            plotlyOutput("ipos_dcsnPlot5")
          ),
          column(
            width = 4,
            plotlyOutput("ipos_dcsnPlot3"),
            plotlyOutput("ipos_dcsnPlot6")
          )
        )
        
      })
      
      output$ind_ntwk_table <- renderDataTable({
        
        DT_in <- 
          ind_svs_filt() %>%
          group_by(ServiceType, short_desc, HCPCS) %>%
          summarize(
            # Concatenate needs
            related_needs = paste(item_desc, collapse = ", "),
            needs = n()
          ) %>%
          arrange(desc(needs)) 
        
        DT_in %>%
          datatable(
            rownames = F,
            colnames = c(
              "Service Type","Service","Code","Related needs from SIS","Needs Addressed"
            ),
            options = list(
              pageLength = nrow(DT_in),
              dom = 't'
            )
          ) %>%
          formatStyle(
            'needs',
            background = styleColorBar(DT_in$needs, 'gray'),
            backgroundSize = '100% 90%',
            backgroundRepeat = 'no-repeat',
            backgroundPosition = 'center'
          ) 
          
      })
      
      output$ind_ntwk_graph <- renderVisNetwork({
        
        visNetwork(ind_ntwk()$nodes, ind_ntwk()$edges, height = "500px", width = "100%") %>% 
          visOptions(
            highlightNearest = list(enabled = T, degree = 1, hover = F)
          ) %>%
          visEdges(
            color = list(color = "#E0EEEE", highlight = "#E1AF00"),
            arrows = list(from = list(enabled = TRUE, scaleFactor = 1))
          ) %>%
          visPhysics(maxVelocity = 5,stabilization = F) %>%
          visLayout(randomSeed = 123) %>%
          visLegend(width = 0.1, position = "right")
        
      })
      
      output$ipos_refer <- renderDataTable({
        
        withProgress(message = 'Thinking...',
                     detail = 'of potential referrals',
                     value = 0.1, 
                     {
                       DT_in <- 
                       q1_3_person() %>% 
                       mutate(
                         type = ifelse(
                           section %in% c("Q1A","Q1B"),
                           yes = level, no = type
                         )
                       ) %>%
                       select(-level) %>%
                       filter(fake_id == rand_id()) %>% 
                       group_by(fake_id) %>%
                       filter(as.Date(sis_date) == max(as.Date(sis_date))) %>%
                       filter(grepl("^Q1",section)) %>% # Include only Section 1 items
                       filter(need_svc == T | import_to == T | import_for == T) %>% 
                       filter(refer_ot == T | refer_nurs == T | refer_sp == T 
                              | refer_pt == T | refer_diet == T) %>%
                       filter(score > 0) %>%
                       ungroup() %>%
                       gather(refer_to,YorN,refer_ot:refer_diet) %>%
                       filter(YorN == T) %>%
                       mutate(refer_to = recode(refer_to,
                                                "'refer_ot' = 'Occupational Therapy';
                                                'refer_nurs' = 'Nursing';
                                                'refer_sp' = 'Speech Pathology';
                                                'refer_pt' = 'Physical Therapy';
                                                'refer_diet' = 'Dietician'")) %>%
                       select(refer_to,item_desc,YorN) %>%
                       group_by(refer_to) %>%
                       summarize(related_needs = paste(item_desc, collapse=", "),
                                 # Concatenate needs
                                 needs = n()) %>%
                       ungroup() %>%
                       arrange(desc(needs)) %>%
                       select(-needs)
                     
                     DT_in %>%
                         datatable(
                           rownames = F,
                           colnames = c("Consider referral to:","Needs noted in SIS"),
                           options = list(pageLength = nrow(DT_in),
                                          dom = 't')
                         )
                     })
        
      }) 
      
      output$sis_svc_ntwk <- renderVisNetwork({
        
        withProgress(message = 'Creating network map ',
                     detail = 'making connections...',
                     value = 0.1, 
                     {
                       tst_need <- needs_matrix
                       rownames(tst_need) <- tst_need$Code
                       tst_need <- 
                         tst_need %>% 
                         select(-Code) %>% 
                         t() %>% 
                         as.data.frame()
                       
                       tst_need$item <- rownames(tst_need)
                       
                       region_filt <- if (input$region == "All") {
                         levels(scrub_sis$PIHP)
                       } else input$region
                       
                       agency_filt <- if (input$agency == "All") {
                         levels(scrub_sis$agency)
                       } else input$agency
                       
                       sis2svc_network <-
                         q1_3_person() %>%
                         mutate(
                           type = ifelse(
                             section %in% c("Q1A","Q1B"),
                             yes = level, no = type
                           )
                         ) %>%
                         select(-level)
                         filter(PIHP %in% region_filt & agency %in% agency_filt) %>%
                         # Identify areas with identified need (>0)
                         filter(score > 0) %>%
                         # Include only endorsed or high need items
                         filter(need_svc == T | import_to == T | import_for == T) %>%
                         select(item,item_desc,score) %>%
                         left_join(tst_need, by = "item") %>%
                         group_by(item) %>%
                         gather(HCPCS,need_mapped,everything(),-item,-item_desc,-score) %>%
                         filter(need_mapped == T) %>%
                         left_join(codemap, by = "HCPCS") %>%
                         select(from = item_desc,
                                to = short_desc,
                                score) %>%
                         group_by(from,to) %>%
                         summarize(avg_score = mean(score),
                                   n = n())
                       
                       nodes <-
                         unique(c(unique(as.character(sis2svc_network$from)),
                                  unique(as.character(sis2svc_network$to)))) %>%
                         data.frame("name_id" = .) %>%
                         # Alphabetize
                         arrange(name_id) %>%
                         # Assign ids starting at 0
                         mutate(id = row_number(name_id)-1,
                                group = ifelse(name_id %in% sis2svc_network$from,
                                               yes = "Needs", no = "Services"))
                       
                       edges <-
                         sis2svc_network %>%
                         ungroup() %>%
                         left_join(nodes, by = c("from" = "name_id")) %>%
                         select(-from) %>%
                         rename(from = id) %>%
                         left_join(nodes, by = c("to" = "name_id")) %>%
                         select(-to) %>%
                         rename(to = id,
                                value = n) %>%
                         mutate(title = paste0(value," people have this need.  ",
                                               "<br>The average score is ", 
                                               round(avg_score, digits = 1))) %>%
                         droplevels()
                       
                       # Calculate degree of node to use as size
                       # Degree = number of edges attached to a given node
                       deg_from <-
                         edges %>%
                         ungroup() %>%
                         group_by(from) %>%
                         summarize(degree = n_distinct(to)) %>%
                         select(id = from, degree)
                       
                       deg <-
                         edges %>%
                         ungroup() %>%
                         group_by(to) %>%
                         summarize(degree = n_distinct(from)) %>%
                         select(id = to, degree) %>%
                         rbind(deg_from) %>%
                         ungroup()
                       
                       nodes %<>% 
                         left_join(deg, by = "id") %>%
                         rename(value = degree,
                                label = name_id)
                       
                       #nodes <- nodes() %>% rename(label = name)
                       
                       visNetwork(nodes, edges, height = "700px", width = "100%") %>% 
                         visOptions(highlightNearest = list(enabled = T, degree = 1, hover = F)) %>%
                         visEdges(color = list(color = "#E0EEEE", highlight = "#E1AF00")) %>%
                         visPhysics(maxVelocity = 5,stabilization = FALSE) %>%
                         visLayout(randomSeed = 123) %>%
                         visLegend(width = 0.1, position = "right")
                     })
        
      })
      
      output$need_scree <- renderPlotly({
        
        scree <- function(df) {
          wss <- (nrow(df) - 1)*sum(apply(df,2,var))
          for (i in 2:15) wss[i] <- sum(kmeans(df,centers = i)$withinss)
          wss %<>% as.data.frame() 
          names(wss)[1] <- "wss"
          wss %<>% mutate(n_clust = row_number())
          return(wss)
        }

        clusterInput() %>%
          scree() %>%
          plot_ly(x = ~n_clust, y = ~wss, height = 200) %>%
          add_lines(alpha = 0.5) %>%
          add_markers(name = "Clusters",
                      hoverinfo = "x") %>%
          layout(xaxis = list(title = "Number of clusters"),
                 yaxis = list(title = "Within groups <br>sum of squares")) %>%
          hide_legend()
        
      })
      
      output$need_grp_dt <- DT::renderDataTable({
        
        if (input$dt_clust_type == "k-means clusters") {
          
          tidy_grp <- 
            cluster_km() %>% 
            tidy() %>%
            select(cluster,size,everything(),-withinss) %>%
            mutate_each(funs = funs(round(.,digits = 3)),
                        starts_with("x"))
          
          # Define color interval breaks
          brks <- tidy_grp %>% select(starts_with("x")) %>% 
            quantile(probs = seq(.05, .95, .05), na.rm = TRUE)
          
          clrs <- round(seq(255, 40, length.out = length(brks) + 1), 0) %>%
          {paste0("rgb(255,", ., ",", ., ")")}  
          
          # Select var names to apply color gradient
          var_names <- tidy_grp %>% select(starts_with("x")) %>% colnames()
          
        } else if (input$dt_clust_type == "hierarchical clusters") {
          
          # Use default dist and hclust methodds to match d3heatmap output
          distances <- dist(clusterInput(), method = "euclidean")
          hc <- hclust(distances, method = "complete")
          cluster <- cutree(hc, k = input$need_rows)
          
          n_obs <-
            clusterInput() %>%
            cbind(cluster) %>%
            mutate(cluster = as.factor(cluster)) %>%
            group_by(cluster) %>%
            summarize(size = n()) 
          
          tidy_grp <-
            clusterInput() %>%
            cbind(cluster) %>%
            mutate(cluster = as.factor(cluster)) %>%
            group_by(cluster) %>%
            summarize_at(vars(medical:advocacy), mean) %>%
            left_join(n_obs, by = "cluster") %>%
            select(cluster,size,everything()) %>%
            mutate_each(funs = funs(round(.,digits = 3)),
                        medical:advocacy)
          
          # Define color interval breaks
          brks <- tidy_grp %>% select(medical:advocacy) %>% as.matrix() %>%
            quantile(probs = seq(.05, .95, .05), na.rm = TRUE)
          
          clrs <- round(seq(255, 40, length.out = length(brks) + 1), 0) %>%
          {paste0("rgb(255,", ., ",", ., ")")}  
          
          # Select var names to apply color gradient
          var_names <- tidy_grp %>% select(medical:advocacy) %>% colnames()
          
        } else print(paste0("Error.  Unrecognized input."))
        
        
        # Make datatable
        tidy_grp %>%
          datatable(rownames = FALSE,
                    colnames = c('Cluster','People',colnames(cluster_km()$centers)),
                    extensions = c('Responsive','Buttons'),
                    options = list(dom = 't', buttons = c('colvis'))) %>%
          # Doesn't currently match levels of palette applied to need_km output
          # formatStyle('cluster', 
          #             backgroundColor = styleEqual(unique(tidy_k$cluster),
          #                                          soft_12[1:length(cluster_km()$centers[,1])])) %>%
          formatStyle(var_names, backgroundColor = styleInterval(brks, clrs)) %>%
          formatStyle('size',
                      background = styleColorBar(tidy_grp$size, 'gray'),
                      backgroundSize = '100% 90%',
                      backgroundRepeat = 'no-repeat',
                      backgroundPosition = 'center')
        
      })
      
      output$cluster_viz_ui <- renderUI({
        
        if (input$dt_clust_type == "k-means clusters") {
          
          box(
            title = "Visualizing Groups",
            status = "warning",
            collapsible = T,
            collapsed = T,
            width = NULL,
            tabBox(
              width = NULL,
              tabPanel(
                "What to compare?",
                p(
                  "People are wonderfully complex, even when you're just looking 
                  at how they score on an assessment. This complexity can be 
                  hard to visualize all at once. Since the k-means algorithm 
                  groups people based on a number of variables taken together (", 
                  em("here, the SIS subscales"), "), it's helpful to look at 
                  different life areas to see how they vary across the clustered 
                  groups. Below you can select the variables you'd like to 
                  visualize before moving to the ", em("Visualize"), " panel."
                  ),
                uiOutput("k_vars")
                ),
              tabPanel(
                "Visualize",
                plotlyOutput("need_km")
              )
            )
          )
        
        } else if (input$dt_clust_type == "hierarchical clusters") {
          
          box(
            title = "Visualizing Groups",
            status = "warning",
            collapsible = T,
            collapsed = T,
            width = NULL,
            tabBox(
              width = NULL,
              tabPanel(
                "About the visualization",
                p(
                  "The visualization here is called a ",
                  a(
                    href = "https://en.wikipedia.org/wiki/Heat_map",
                    "heatmap"
                  ),
                  ".  This one shows the most recent scores for each 
                  client who has received a SIS assessment. Each client is 
                  depicted as a row in the heatmap.  The values of the scores
                  for each subscale have been ", 
                  a(
                    href = "https://stat.ethz.ch/R-manual/R-devel/library/base/html/scale.html",
                    "normalized"
                  ),
                  " to allow for comparison.  Darker blue means a higher 
                  score, while lighter blue means a lower score. You can 
                  click and drag over cells to zoom in and look more 
                  closely at a given set."),
                p("Here you can look at broader patterns of need across life 
                  domains for the current population of clients who have been 
                  assessed.  The root-like shapes on the sides of the heatmap 
                  are called", 
                  a(
                    href = "https://en.wikipedia.org/wiki/Dendrogram",
                    "dendrograms"
                  ),
                  "and they show how the different elements (here, clients and 
                  subscales) are grouped.  The clusters clients whose 
                  patterns of need are most distinct based on the SIS subscales 
                  are shown in different colors. To allow you to more easily see these 
                  groupings, the heatmap allows you to select a number of groups 
                  (colors) to highlight for both the rows and columns."
                )
              ),
              tabPanel(
                "Plot",
                d3heatmapOutput("need_heat")
              )
            )
          )
          
        } else print(paste0("Error.  Unrecognized input."))
        
      })
      
      output$need_km <- renderPlotly({
        
        df <-
        cluster_km() %>% 
          augment(clusterInput()) 
        
        # Rename cols based on inputs
        df$xvar <- df[ ,which( colnames(df) == input$kmPlot_x )]
        df$yvar <- df[ ,which( colnames(df) == input$kmPlot_y )]
        df$zvar <- df[ ,which( colnames(df) == input$kmPlot_z )]
        df$sizevar <- df[ ,which( colnames(df) == input$kmPlot_size )]
        
        df %>%
          group_by(.cluster) %>%
          plot_ly(x = ~xvar, 
                  y = ~yvar, 
                  z = ~zvar,
                  p = ~sizevar,
                  hoverinfo = 'text',
                  text = ~paste(input$kmPlot_x, '(x): ', round(xvar, digits = 2),
                                '</br>', input$kmPlot_y, '(y): ', round(yvar, digits = 2),
                                '</br>', input$kmPlot_z, '(z): ', round(zvar, digits = 2),
                                '</br>', input$kmPlot_size, '(size): ', round(sizevar, digits = 2)),
                  color = ~.cluster,
                  colors = soft_12) %>%
          add_markers(size = ~sizevar, 
                      sizes = c(10, 500)) %>%
          layout(scene = list(xaxis = list(title = input$kmPlot_x), 
                              yaxis = list(title = input$kmPlot_y), 
                              zaxis = list(title = input$kmPlot_z)))
        
      })
      
      output$need_heat <- renderD3heatmap({
        
        withProgress(
          message = 'Creating heatmap...',
          detail = 'Clustering can take awhile...',
          value = 0.1, 
          {
           d3heatmap(
             clusterInput(), 
             colors = "Blues",
             dendrogram = "row",
             k_row = input$need_rows, 
             theme = "",
             yaxis_font_size =  "0pt",
             show_grid = F
           )
          }
        )
        
      })
      
      output$dt_qual_all <- DT::renderDataTable({
        
        overview() %>%
          # work around due to not formatting properly in formatPercentage below
          mutate(pct_no_to = paste0(round(pct_no_to*100, digits = 0), "%"),
                 pct_no_for = paste0(round(pct_no_for*100, digits = 0), "%")) %>%
          select(med_duration,med_attend,pct_attend,
                 pct_no_to,pct_no_for) %>%
          datatable(rownames = FALSE,
                    colnames = c('Median Duration',
                                 'Median # of Attendees',
                                 "% Attended by Individual",
                                 "% No Important To",
                                 "% No Important For"),
                    options = list(dom = 't')) %>%
          formatPercentage("pct_attend") %>%
          formatStyle(1:5,'text-align' = 'right') 
        
      })
      
      output$dt_miss_all <- DT::renderDataTable({
        
        overview() %>%
          select(n,miss_start,miss_end,miss_reason,not_mich) %>%
          datatable(rownames = FALSE,
                    colnames = c('# Assessments',
                                 'Missing Start Time',
                                 'Missing End Time',
                                 'Missing Reason',
                                 'State other than MI'),
                    options = list(dom = 't'))
        
      })
      
      output$dt_cor_all <- DT::renderDataTable({

        overview() %>%
          select(starts_with("cor_")) %>%
          datatable(rownames = FALSE,
                    colnames = c('Home appliances & Learning with tech',
                                 'Learning health skills & Nutrition/diet',
                                 'Learning health skills & Physical fitness',
                                 'Nutrition/diet & Physical fitness',
                                 'Transportation & Using public services',
                                 'Social skills & Socializing outside',
                                 'Socializing outside & Visit Friends/Family',
                                 'Socializing outside & Socializing at home',
                                 'Friendship & Intimate relationships',
                                 'Learning self-determination & Self-advocacy',
                                 'Self-advocacy & Advocating for others'),
                    extensions = c('Responsive','Buttons'),
                    options = list(dom = 't',
                                   buttons = c('colvis'))) %>%
          formatStyle('cor_2a1_2c9',
                      backgroundColor = styleInterval(c(0.3, 0.5, 0.7), c('lightgrey','Silver','lightsteelblue','steelblue')),
                      backgroundSize = '100% 90%', backgroundRepeat = 'no-repeat',
                      backgroundPosition = 'center') %>%
          formatStyle('cor_2c3_2e6',
                      backgroundColor = styleInterval(c(0.3, 0.5, 0.7), c('lightgrey','Silver','lightsteelblue','steelblue')),
                      backgroundSize = '100% 90%', backgroundRepeat = 'no-repeat',
                      backgroundPosition = 'center') %>%
          formatStyle('cor_2c3_2e7',
                      backgroundColor = styleInterval(c(0.3, 0.5, 0.7), c('lightgrey','Silver','lightsteelblue','steelblue')),
                      backgroundSize = '100% 90%', backgroundRepeat = 'no-repeat',
                      backgroundPosition = 'center') %>%
          formatStyle('cor_2e6_2e7',
                      backgroundColor = styleInterval(c(0.3, 0.5, 0.7), c('lightgrey','Silver','lightsteelblue','steelblue')),
                      backgroundSize = '100% 90%', backgroundRepeat = 'no-repeat',
                      backgroundPosition = 'center') %>%
          formatStyle('cor_2b1_2b5',
                      backgroundColor = styleInterval(c(0.3, 0.5, 0.7), c('lightgrey','Silver','lightsteelblue','steelblue')),
                      backgroundSize = '100% 90%', backgroundRepeat = 'no-repeat',
                      backgroundPosition = 'center') %>%
          formatStyle('cor_2f1_2f3',
                      backgroundColor = styleInterval(c(0.3, 0.5, 0.7), c('lightgrey','Silver','lightsteelblue','steelblue')),
                      backgroundSize = '100% 90%', backgroundRepeat = 'no-repeat',
                      backgroundPosition = 'center') %>%
          formatStyle('cor_2f3_2b8',
                      backgroundColor = styleInterval(c(0.3, 0.5, 0.7), c('lightgrey','Silver','lightsteelblue','steelblue')),
                      backgroundSize = '100% 90%', backgroundRepeat = 'no-repeat',
                      backgroundPosition = 'center') %>%
          formatStyle('cor_2f3_2f6',
                      backgroundColor = styleInterval(c(0.3, 0.5, 0.7), c('lightgrey','Silver','lightsteelblue','steelblue')),
                      backgroundSize = '100% 90%', backgroundRepeat = 'no-repeat',
                      backgroundPosition = 'center') %>%
          formatStyle('cor_2f4_2f5',
                      backgroundColor = styleInterval(c(0.3, 0.5, 0.7), c('lightgrey','Silver','lightsteelblue','steelblue')),
                      backgroundSize = '100% 90%', backgroundRepeat = 'no-repeat',
                      backgroundPosition = 'center') %>%
          formatStyle('cor_2c4_3a1',
                      backgroundColor = styleInterval(c(0.3, 0.5, 0.7), c('lightgrey','Silver','lightsteelblue','steelblue')),
                      backgroundSize = '100% 90%', backgroundRepeat = 'no-repeat',
                      backgroundPosition = 'center') %>%
          formatStyle('cor_3A1_3A8',
                      backgroundColor = styleInterval(c(0.3, 0.5, 0.7), c('lightgrey','Silver','lightsteelblue','steelblue')),
                      backgroundSize = '100% 90%', backgroundRepeat = 'no-repeat',
                      backgroundPosition = 'center')

      })
      
      
      output$dt_miss <- DT::renderDataTable({
        
        is_current <- if (input$current == "Current assessors") {
          c(TRUE)
        } else if (input$current == "All Assessors") {
          c(TRUE, FALSE)
        } else print(paste0("Error.  Unrecognized input."))
        
        interviewer() %>%
        filter(current_int %in% is_current) %>%
        select(interviewer,miss_start,miss_end,miss_reason,
               not_mich,pct_no_to,pct_no_for) %>%
        datatable(rownames = FALSE,
                  colnames = c('Interviewer',
                               'Missing Start Time',
                               'Missing End Time',
                               'Missing Reason',
                               'State other than MI',
                               '% No Important To',
                               '% No Important For'),
                  caption = 'Data Quality Issues, by Interviewer',
                  extensions = c('Responsive','Buttons'),
                  options = list(pageLength = 5, lengthMenu = c(5, 10,20),
                                 dom = 'C<"clear">lfrtip',
                                 buttons = c('colvis'))) %>%
          formatPercentage(c('pct_no_to',"pct_no_for")) %>%
          formatStyle('miss_start',
                      backgroundColor = styleInterval(c(
                        quantile(interviewer()$miss_start, 0.25, na.rm = T),
                        quantile(interviewer()$miss_start, 0.50, na.rm = T),
                        quantile(interviewer()$miss_start, 0.75, na.rm = T))
                        , c('steelblue','lightsteelblue','Silver','lightgrey')),
                      backgroundSize = '100% 90%', backgroundRepeat = 'no-repeat',
                      backgroundPosition = 'center') %>%
          formatStyle('miss_end',
                      backgroundColor = styleInterval(c(
                        quantile(interviewer()$miss_end, 0.25, na.rm = T),
                        quantile(interviewer()$miss_end, 0.50, na.rm = T),
                        quantile(interviewer()$miss_end, 0.75, na.rm = T))
                        , c('steelblue','lightsteelblue','Silver','lightgrey')),
                      backgroundSize = '100% 90%', backgroundRepeat = 'no-repeat',
                      backgroundPosition = 'center') %>%
          formatStyle('miss_reason',
                      backgroundColor = styleInterval(c(
                        quantile(interviewer()$miss_reason, 0.25, na.rm = T),
                        quantile(interviewer()$miss_reason, 0.50, na.rm = T),
                        quantile(interviewer()$miss_reason, 0.75, na.rm = T))
                        , c('steelblue','lightsteelblue','Silver','lightgrey')),
                      backgroundSize = '100% 90%', backgroundRepeat = 'no-repeat',
                      backgroundPosition = 'center') %>%
          formatStyle('not_mich',
                      backgroundColor = styleInterval(c(
                        quantile(interviewer()$not_mich, 0.25, na.rm = T),
                        quantile(interviewer()$not_mich, 0.50, na.rm = T),
                        quantile(interviewer()$not_mich, 0.75, na.rm = T))
                        , c('steelblue','lightsteelblue','Silver','lightgrey')),
                      backgroundSize = '100% 90%', backgroundRepeat = 'no-repeat',
                      backgroundPosition = 'center') %>%
          formatStyle('pct_no_to',
                      backgroundColor = styleInterval(c(0.25, 0.5, 0.75), c('steelblue','lightsteelblue','Silver','lightgrey')),
                      backgroundSize = '100% 90%', backgroundRepeat = 'no-repeat',
                      backgroundPosition = 'center') %>%
          formatStyle('pct_no_for',
                      backgroundColor = styleInterval(c(0.25, 0.5, 0.75), c('steelblue','lightsteelblue','Silver','lightgrey')),
                      backgroundSize = '100% 90%', backgroundRepeat = 'no-repeat',
                      backgroundPosition = 'center')

      })
      
      output$dt_datqualcor <- DT::renderDataTable({
        
        is_current <- if (input$current == "Current assessors") {
          c(TRUE)
        } else if (input$current == "All Assessors") {
          c(TRUE, FALSE)
        } else print(paste0("Error.  Unrecognized input."))
        
        interviewer() %>%
          filter(current_int %in% is_current) %>%
          select(interviewer,n,starts_with("cor_")) %>%
          filter(n > 1) %>%
          mutate(n_strong = rowSums(.[,c(3:13)] > 0.7, na.rm = T) / 11) %>%
          select(interviewer,n_strong,starts_with("cor_")) %>%
          datatable(caption = 'Correlation of related SIS assessment items by Interviewer',
                    rownames = FALSE,
                    colnames = c('Interviewer',
                                 '% with Strong Correlation',
                                 'Home appliances & Learning with tech',
                                 'Learning health skills & Nutrition/diet',
                                 'Learning health skills & Physical fitness',
                                 'Nutrition/diet & Physical fitness',
                                 'Transportation & Using public services',
                                 'Social skills & Socializing outside',
                                 'Socializing outside & Visit Friends/Family',
                                 'Socializing outside & Socializing at home',
                                 'Friendship & Intimate relationships',
                                 'Learning self-determination & Self-advocacy',
                                 'Self-advocacy & Advocating for others'),
                    extensions = c('Responsive','Buttons'),
                    options = list(pageLength = 150, lengthMenu = c(10,50,150),
                                   dom = 'C<"clear">lfrtip',
                                   buttons = c('colvis')),
                    filter = 'top') %>%
          formatPercentage('n_strong') %>%
          formatStyle('cor_2a1_2c9',
                      backgroundColor = styleInterval(c(0.3, 0.5, 0.7), c('lightgrey','Silver','lightsteelblue','steelblue')),
                      backgroundSize = '100% 90%', backgroundRepeat = 'no-repeat',
                      backgroundPosition = 'center') %>%
          formatStyle('cor_2c3_2e6',
                      backgroundColor = styleInterval(c(0.3, 0.5, 0.7), c('lightgrey','Silver','lightsteelblue','steelblue')),
                      backgroundSize = '100% 90%', backgroundRepeat = 'no-repeat',
                      backgroundPosition = 'center') %>%
          formatStyle('cor_2c3_2e7',
                      backgroundColor = styleInterval(c(0.3, 0.5, 0.7), c('lightgrey','Silver','lightsteelblue','steelblue')),
                      backgroundSize = '100% 90%', backgroundRepeat = 'no-repeat',
                      backgroundPosition = 'center') %>%
          formatStyle('cor_2e6_2e7',
                      backgroundColor = styleInterval(c(0.3, 0.5, 0.7), c('lightgrey','Silver','lightsteelblue','steelblue')),
                      backgroundSize = '100% 90%', backgroundRepeat = 'no-repeat',
                      backgroundPosition = 'center') %>%
          formatStyle('cor_2b1_2b5',
                      backgroundColor = styleInterval(c(0.3, 0.5, 0.7), c('lightgrey','Silver','lightsteelblue','steelblue')),
                      backgroundSize = '100% 90%', backgroundRepeat = 'no-repeat',
                      backgroundPosition = 'center') %>%
          formatStyle('cor_2f1_2f3',
                      backgroundColor = styleInterval(c(0.3, 0.5, 0.7), c('lightgrey','Silver','lightsteelblue','steelblue')),
                      backgroundSize = '100% 90%', backgroundRepeat = 'no-repeat',
                      backgroundPosition = 'center') %>%
          formatStyle('cor_2f3_2b8',
                      backgroundColor = styleInterval(c(0.3, 0.5, 0.7), c('lightgrey','Silver','lightsteelblue','steelblue')),
                      backgroundSize = '100% 90%', backgroundRepeat = 'no-repeat',
                      backgroundPosition = 'center') %>%
          formatStyle('cor_2f3_2f6',
                      backgroundColor = styleInterval(c(0.3, 0.5, 0.7), c('lightgrey','Silver','lightsteelblue','steelblue')),
                      backgroundSize = '100% 90%', backgroundRepeat = 'no-repeat',
                      backgroundPosition = 'center') %>%
          formatStyle('cor_2f4_2f5',
                      backgroundColor = styleInterval(c(0.3, 0.5, 0.7), c('lightgrey','Silver','lightsteelblue','steelblue')),
                      backgroundSize = '100% 90%', backgroundRepeat = 'no-repeat',
                      backgroundPosition = 'center') %>%
          formatStyle('cor_2c4_3a1',
                      backgroundColor = styleInterval(c(0.3, 0.5, 0.7), c('lightgrey','Silver','lightsteelblue','steelblue')),
                      backgroundSize = '100% 90%', backgroundRepeat = 'no-repeat',
                      backgroundPosition = 'center') %>%
          formatStyle('cor_3A1_3A8',
                      backgroundColor = styleInterval(c(0.3, 0.5, 0.7), c('lightgrey','Silver','lightsteelblue','steelblue')),
                      backgroundSize = '100% 90%', backgroundRepeat = 'no-repeat',
                      backgroundPosition = 'center')
        
      })
      
      output$dt_datqual <- DT::renderDataTable({
        
        is_current <- if (input$current == "Current assessors") {
          c(TRUE)
        } else if (input$current == "All Assessors") {
          c(TRUE, FALSE)
        } else print(paste0("Error.  Unrecognized input."))
        
        interviewer() %>%
          filter(current_int %in% is_current) %>%
          select(interviewer,n,med_days_btwn,med_duration,pct_no_to,
                 pct_no_for,med_attend,pct_attend) %>%
          datatable(rownames = FALSE,
                    colnames = c('Interviewer',
                                 '# Assessments',
                                 'Median Days Between Assessments',
                                 'Median Duration',
                                 '% No Important To',
                                 '% No Important For',
                                 'Median # of Attendees',
                                 "% Attended by Individual"),
                    caption = 'Assessment Overview, by Interviewer',
                    extensions = c('Responsive','Buttons'),
                    options = list(pageLength = 5, lengthMenu = c(5, 10,20),
                                   dom = 'C<"clear">lfrtip',
                                   buttons = c('colvis'))) %>%
          formatPercentage(c('pct_no_to',"pct_no_for","pct_attend")) %>%
          formatStyle('med_days_btwn',
                      backgroundColor = styleInterval(c(
                        quantile(interviewer()$med_days_btwn, 0.25, na.rm = T),
                        quantile(interviewer()$med_days_btwn, 0.50, na.rm = T),
                        quantile(interviewer()$med_days_btwn, 0.75, na.rm = T))
                        , c('steelblue','lightsteelblue','Silver','lightgrey')),
                    backgroundSize = '100% 90%', backgroundRepeat = 'no-repeat',
                    backgroundPosition = 'center') %>%
          formatStyle('med_duration',
                      backgroundColor = styleInterval(c(
                        quantile(interviewer()$med_duration, 0.25, na.rm = T),
                        quantile(interviewer()$med_duration, 0.50, na.rm = T),
                        quantile(interviewer()$med_duration, 0.75, na.rm = T))
                        , c('lightgrey','Silver','lightsteelblue','steelblue')),
                      backgroundSize = '100% 90%', backgroundRepeat = 'no-repeat',
                      backgroundPosition = 'center') %>%
          formatStyle('pct_no_to',
                      backgroundColor = styleInterval(c(0.25,0.5,0.75), c('steelblue','lightsteelblue','Silver','lightgrey')),
                      backgroundSize = '100% 90%', backgroundRepeat = 'no-repeat',
                      backgroundPosition = 'center') %>%
          formatStyle('pct_no_for',
                      backgroundColor = styleInterval(c(0.25,0.5,0.75), c('steelblue','lightsteelblue','Silver','lightgrey')),
                      backgroundSize = '100% 90%', backgroundRepeat = 'no-repeat',
                      backgroundPosition = 'center') %>%
          formatStyle('med_attend',
                      backgroundColor = styleInterval(c(
                        quantile(interviewer()$med_attend, 0.25, na.rm = T),
                        quantile(interviewer()$med_attend, 0.50, na.rm = T),
                        quantile(interviewer()$med_attend, 0.75, na.rm = T))
                        , c('lightgrey','Silver','lightsteelblue','steelblue')),
                      backgroundSize = '100% 90%', backgroundRepeat = 'no-repeat',
                      backgroundPosition = 'center') %>%
          formatStyle('pct_attend',
                      backgroundColor = styleInterval(c(0.25,0.5,0.75), c('lightgrey','Silver','lightsteelblue','steelblue')),
                      backgroundSize = '100% 90%', backgroundRepeat = 'no-repeat',
                      backgroundPosition = 'center')
        
      })
      
      output$sis_docs <- renderUI({
        
        box(
          title = "Supports Intensity Scale (SIS) Documentation",
          status = "warning",
          collapsible = F,
          collapsed = F,
          width = NULL,
          tabBox(
            width = NULL,
            tabPanel(
              "Validity and Reliability",
              p(
                "The studies listed below demonstrate the validity and inter-rater 
                reliability of the Supports Intensity Scale instrument:"
              ),
              tags$ul(
                tags$li(
                  tags$a(
                    href = "https://www.researchgate.net/profile/Marc_Tasse/publication/242208218_Psychometric_Properties_of_the_Supports_Intensity_Scale/links/0046352f16ae154df0000000.pdf", 
                    "Buntinx, W., Cobigo, V., McLaughlin, C., Morin, D., 
                    Tasse, M., & Thompson, J. R. (2008). Psychometric Properties 
                    of the Supports Intensity Scale. AAIDD SIS White Paper 
                    Series, 40-49."
                  )
                ),
                tags$li(
                  tags$a(
                    href = "https://www.researchgate.net/profile/Goele_Bossaert/publication/45088932_Factorial_Validity_of_the_Supports_Intensity_Scale_SIS/links/09e41501f831fe8825000000/Factorial-Validity-of-the-Supports-Intensity-Scale-SIS.pdf",
                    "Kuppens, S., Bossaert, G., Buntinx, W., Molleman, C., 
                    Van den Abbeele, A., & Maes, B. (2010). Factorial validity 
                    of the supports intensity scale (SIS). American journal on 
                    intellectual and developmental disabilities, 115(4), 327-339."
                  )
                ),
                tags$li(
                  tags$a(
                    href = "https://link.springer.com/article/10.1007/s10882-011-9227-3",
                    "Smit, W., Sabbe, B., & Prinzie, P. (2011). Reliability and 
                    validity of the Supports Intensity Scale (SIS) measured in 
                    adults with physical disabilities. Journal of developmental 
                    and physical disabilities, 23(4), 277-287. "
                  )
                ),
                tags$li(
                  tags$a(
                    href = "http://www.aaiddjournals.org/doi/abs/10.1352/2326-6988-2.2.100",
                    "Shogren, K. A., Thompson, J. R., Wehmeyer, M. L., 
                    Chapman, T., Tassé, M. J., & McLaughlin, C. A. (2014). 
                    Reliability and validity of the supplemental protection and 
                    advocacy scale of the supports intensity scale. Inclusion, 
                    2(2), 100-109."
                  )
                ),
                tags$li(
                  tags$a(
                    href = "https://pdfs.semanticscholar.org/8763/60ca66e37bb0b043106f126eadb2dac77641.pdf",
                    "Thompson, J. R., Tassé, M. J., & McLaughlin, C. A. (2008). 
                    Interrater reliability of the Supports Intensity Scale (SIS). 
                    AJMR, 113(3), 231."
                  )
                ),
                tags$li(
                  tags$a(
                    href = "http://www.sciencedirect.com/science/article/pii/S0891422209000092",
                    "Weiss, J. A., Lunsky, Y., Tassé, M. J., & Durbin, J. (2009). 
                    Support for the construct validity of the Supports Intensity 
                    Scale based on clinician rankings of need. Research in 
                    developmental disabilities, 30(5), 933-941."
                  )
                )
              )
            ),
            tabPanel(
              "Use in Person-Centered Planning",
              p(
                "The studies listed below demonstrate the use of the Supports 
                Intensity Scale (SIS) instrument to inform person-centered 
                planning:"
              ),
              tags$ul(
                tags$li(
                  tags$a(
                    href = "http://bonhamresearch.com/PDF/2008SchalockEnhancing%20Personal%20Outcomes%20JPPID.pdf",
                    "Schalock, R. L., Verdugo, M. A., Bonham, G. S., Fantova, F., 
                    & Van Loon, J. (2008). Enhancing personal outcomes: 
                    Organizational strategies, guidelines, and examples. Journal 
                    of Policy and Practice in Intellectual Disabilities, 5(4), 
                    276-285."
                  )
                ),
                tags$li(
                  tags$a(
                    href = "https://biblio.ugent.be/publication/1169626/file/6748818.pdf",
                    "Van Loon, J., Claes, C., Vandevelde, S., Van Hove, G., & 
                    Schalock, R. L. (2010). Assessing individual support needs 
                    to enhance personal outcomes. Exceptionality, 18(4), 193-202."
                  )
                ),
                tags$li(
                  tags$a(
                    href = "https://www.researchgate.net/profile/Todd_Little/publication/23787619_Efficacy_of_the_Supports_Intensity_Scale_SIS_to_Predict_Extraordinary_Support_Needs/links/0c96052bb754f42e8c000000.pdf",
                    "Wehmeyer, M., Chapman, T. E., Little, T. D., Thompson, J. R., 
                    Schalock, R., & Tasse, M. J. Efficacy of the Supports 
                    Intensity Scale (SIS) to Predict Extraordinary Support Needs."
                  )
                )
              )
            ),
            tabPanel(
              "Use at Systems Level",
              p(
                "The studies listed below demonstrate the use of the Supports 
                Intensity Scale (SIS) instrument at the systems level:"
              ),
              tags$ul(
                tags$li(
                  tags$a(
                    href = "http://buntinx.org/yahoo_site_admin/assets/docs/Models_of_Disability_-_Buntinx__Schalock_2010_JPPID.144132950.pdf",
                    "Buntinx, W. H., & Schalock, R. L. (2010). Models of 
                    disability, quality of life, and individualized supports: 
                    Implications for professional practice in intellectual 
                    disability. Journal of Policy and Practice in Intellectual 
                    Disabilities, 7(4), 283-294. "
                  )
                ),
                tags$li(
                  tags$a(
                    href = "https://www.academia.edu/35095940/The_use_of_evidence-based_outcomes_in_systems_and_organizations_providing_services_and_supports_to_persons_with_intellectual_disability",
                    "van Loon, J. H., Bonham, G. S., Peterson, D. D., Schalock, 
                    R. L., Claes, C., & Decramer, A. E. (2013). The use of 
                    evidence-based outcomes in systems and organizations 
                    providing services and supports to persons with intellectual 
                    disability. Evaluation and Program Planning, 36(1), 80-87."
                  )
                )
              )
            )
          )
        )
        
      })
      
    }
  )
      